<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Linux Driver Development Manual: Linux Driver Model</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Linux Driver Development Manual
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">Comprehensive guide to Linux kernel and device driver development</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Linux Driver Model </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md394"></a>
Overview</h1>
<p>The Linux Driver Model provides a unified framework for device drivers, power management, and hot-plugging. It organizes devices, drivers, and buses in a hierarchical structure represented in sysfs.</p>
<h1><a class="anchor" id="autotoc_md395"></a>
Core Components</h1>
<h2><a class="anchor" id="autotoc_md396"></a>
Devices</h2>
<p>Physical or virtual hardware</p>
<h2><a class="anchor" id="autotoc_md397"></a>
Drivers</h2>
<p>Software that controls devices</p>
<h2><a class="anchor" id="autotoc_md398"></a>
Buses</h2>
<p>Communication channels connecting devices</p>
<h2><a class="anchor" id="autotoc_md399"></a>
Classes</h2>
<p>Grouping of devices by functionality</p>
<h1><a class="anchor" id="autotoc_md400"></a>
Device Structure</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/device.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>device {</div>
<div class="line">    <span class="keyword">struct </span>device *parent;</div>
<div class="line">    <span class="keyword">struct </span>device_private *p;</div>
<div class="line">    <span class="keyword">struct </span>kobject kobj;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *init_name;</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">struct </span>device_type *type;</div>
<div class="line">    <span class="keyword">struct </span>bus_type *bus;</div>
<div class="line">    <span class="keyword">struct </span>device_driver *driver;</div>
<div class="line">    <span class="keywordtype">void</span> *platform_data;</div>
<div class="line">    <span class="keywordtype">void</span> *driver_data;</div>
<div class="line">    <span class="keyword">struct </span>dev_pm_info power;</div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md401"></a>
Device Registration</h2>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> device_register(<span class="keyword">struct</span> device *dev);</div>
<div class="line"><span class="keywordtype">void</span> device_unregister(<span class="keyword">struct</span> device *dev);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Initialize device</span></div>
<div class="line"><span class="keywordtype">void</span> device_initialize(<span class="keyword">struct</span> device *dev);</div>
<div class="line"><span class="keywordtype">int</span> device_add(<span class="keyword">struct</span> device *dev);</div>
<div class="line"><span class="keywordtype">void</span> device_del(<span class="keyword">struct</span> device *dev);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md402"></a>
Example</h2>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>device my_device = {</div>
<div class="line">    .init_name = <span class="stringliteral">&quot;mydevice&quot;</span>,</div>
<div class="line">    .release = my_device_release,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> my_device_release(<span class="keyword">struct</span> device *dev)</div>
<div class="line">{</div>
<div class="line">    printk(KERN_INFO <span class="stringliteral">&quot;Device released\n&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> __init my_init(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line">    </div>
<div class="line">    ret = device_register(&amp;my_device);</div>
<div class="line">    <span class="keywordflow">if</span> (ret) {</div>
<div class="line">        printk(KERN_ERR <span class="stringliteral">&quot;Failed to register device\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> ret;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> __exit my_exit(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    device_unregister(&amp;my_device);</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md403"></a>
Driver Structure</h1>
<div class="fragment"><div class="line"><span class="keyword">struct </span>device_driver {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *name;</div>
<div class="line">    <span class="keyword">struct </span>bus_type *bus;</div>
<div class="line">    <span class="keyword">struct </span>module *owner;</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">struct </span>of_device_id *of_match_table;</div>
<div class="line">    int (*probe)(<span class="keyword">struct </span>device *dev);</div>
<div class="line">    int (*remove)(<span class="keyword">struct </span>device *dev);</div>
<div class="line">    void (*shutdown)(<span class="keyword">struct </span>device *dev);</div>
<div class="line">    int (*suspend)(<span class="keyword">struct </span>device *dev, pm_message_t state);</div>
<div class="line">    int (*resume)(<span class="keyword">struct </span>device *dev);</div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md404"></a>
Driver Registration</h2>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> driver_register(<span class="keyword">struct</span> device_driver *drv);</div>
<div class="line"><span class="keywordtype">void</span> driver_unregister(<span class="keyword">struct</span> device_driver *drv);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md405"></a>
Bus Type</h1>
<div class="fragment"><div class="line"><span class="keyword">struct </span>bus_type {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *name;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *dev_name;</div>
<div class="line">    <span class="keyword">struct </span>device *dev_root;</div>
<div class="line">    int (*match)(<span class="keyword">struct </span>device *dev, <span class="keyword">struct </span>device_driver *drv);</div>
<div class="line">    int (*probe)(<span class="keyword">struct </span>device *dev);</div>
<div class="line">    int (*remove)(<span class="keyword">struct </span>device *dev);</div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md406"></a>
Bus Registration</h2>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> bus_register(<span class="keyword">struct</span> bus_type *bus);</div>
<div class="line"><span class="keywordtype">void</span> bus_unregister(<span class="keyword">struct</span> bus_type *bus);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md407"></a>
Example: Custom Bus</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/device.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/module.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Custom bus match function</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> my_bus_match(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_driver *drv)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Match by name</span></div>
<div class="line">    <span class="keywordflow">return</span> !strcmp(dev_name(dev), drv-&gt;name);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>bus_type my_bus_type = {</div>
<div class="line">    .name = <span class="stringliteral">&quot;my_bus&quot;</span>,</div>
<div class="line">    .match = my_bus_match,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> __init my_bus_init(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line">    </div>
<div class="line">    ret = bus_register(&amp;my_bus_type);</div>
<div class="line">    <span class="keywordflow">if</span> (ret) {</div>
<div class="line">        printk(KERN_ERR <span class="stringliteral">&quot;Failed to register bus\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> ret;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    printk(KERN_INFO <span class="stringliteral">&quot;Bus registered\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> __exit my_bus_exit(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    bus_unregister(&amp;my_bus_type);</div>
<div class="line">    printk(KERN_INFO <span class="stringliteral">&quot;Bus unregistered\n&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">module_init(my_bus_init);</div>
<div class="line">module_exit(my_bus_exit);</div>
<div class="line"> </div>
<div class="line">MODULE_LICENSE(<span class="stringliteral">&quot;GPL&quot;</span>);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md408"></a>
Device Class</h1>
<p>Groups devices by functionality.</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>class {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *name;</div>
<div class="line">    <span class="keyword">struct </span>module *owner;</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">struct </span>attribute_group **dev_groups;</div>
<div class="line">    int (*dev_uevent)(<span class="keyword">struct </span>device *dev, <span class="keyword">struct </span>kobj_uevent_env *env);</div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md409"></a>
Class Operations</h2>
<div class="fragment"><div class="line"><span class="comment">// Create class</span></div>
<div class="line"><span class="keyword">struct </span>class *class_create(<span class="keyword">struct</span> module *owner, <span class="keyword">const</span> <span class="keywordtype">char</span> *name);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Destroy class</span></div>
<div class="line"><span class="keywordtype">void</span> class_destroy(<span class="keyword">struct</span> <span class="keyword">class</span> *cls);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create device in class</span></div>
<div class="line"><span class="keyword">struct </span>device *device_create(<span class="keyword">struct</span> <span class="keyword">class</span> *cls,</div>
<div class="line">                            <span class="keyword">struct</span> device *parent,</div>
<div class="line">                            dev_t devt,</div>
<div class="line">                            <span class="keywordtype">void</span> *drvdata,</div>
<div class="line">                            <span class="keyword">const</span> <span class="keywordtype">char</span> *fmt, ...);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Destroy device</span></div>
<div class="line"><span class="keywordtype">void</span> device_destroy(<span class="keyword">struct</span> <span class="keyword">class</span> *cls, dev_t devt);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md410"></a>
Example</h2>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>class *my_class;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>device *my_device;</div>
<div class="line"><span class="keyword">static</span> dev_t devt;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> __init class_init(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Create class</span></div>
<div class="line">    my_class = class_create(THIS_MODULE, <span class="stringliteral">&quot;myclass&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (IS_ERR(my_class))</div>
<div class="line">        <span class="keywordflow">return</span> PTR_ERR(my_class);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Allocate device number</span></div>
<div class="line">    alloc_chrdev_region(&amp;devt, 0, 1, <span class="stringliteral">&quot;mydevice&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Create device</span></div>
<div class="line">    my_device = device_create(my_class, NULL, devt, NULL, <span class="stringliteral">&quot;mydevice&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (IS_ERR(my_device)) {</div>
<div class="line">        class_destroy(my_class);</div>
<div class="line">        unregister_chrdev_region(devt, 1);</div>
<div class="line">        <span class="keywordflow">return</span> PTR_ERR(my_device);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> __exit class_exit(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    device_destroy(my_class, devt);</div>
<div class="line">    class_destroy(my_class);</div>
<div class="line">    unregister_chrdev_region(devt, 1);</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md411"></a>
Kobject</h1>
<p>Base object for device model.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/kobject.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>kobject {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *name;</div>
<div class="line">    <span class="keyword">struct </span>list_head entry;</div>
<div class="line">    <span class="keyword">struct </span>kobject *parent;</div>
<div class="line">    <span class="keyword">struct </span>kset *kset;</div>
<div class="line">    <span class="keyword">struct </span>kobj_type *ktype;</div>
<div class="line">    <span class="keyword">struct </span>kernfs_node *sd;</div>
<div class="line">    <span class="keyword">struct </span>kref kref;</div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md412"></a>
Kobject Operations</h2>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> kobject_init(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">struct</span> kobj_type *ktype);</div>
<div class="line"><span class="keywordtype">int</span> kobject_add(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">struct</span> kobject *parent, <span class="keyword">const</span> <span class="keywordtype">char</span> *fmt, ...);</div>
<div class="line"><span class="keywordtype">int</span> kobject_init_and_add(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">struct</span> kobj_type *ktype,</div>
<div class="line">                        <span class="keyword">struct</span> kobject *parent, <span class="keyword">const</span> <span class="keywordtype">char</span> *fmt, ...);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> kobject_del(<span class="keyword">struct</span> kobject *kobj);</div>
<div class="line"><span class="keywordtype">void</span> kobject_put(<span class="keyword">struct</span> kobject *kobj);</div>
<div class="line"><span class="keyword">struct </span>kobject *kobject_get(<span class="keyword">struct</span> kobject *kobj);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md413"></a>
Sysfs Attributes</h1>
<h2><a class="anchor" id="autotoc_md414"></a>
Device Attributes</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/device.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Define attribute</span></div>
<div class="line"><span class="keyword">static</span> ssize_t my_show(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_attribute *attr, <span class="keywordtype">char</span> *buf)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> sprintf(buf, <span class="stringliteral">&quot;Hello from sysfs\n&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> ssize_t my_store(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_attribute *attr,</div>
<div class="line">                       <span class="keyword">const</span> <span class="keywordtype">char</span> *buf, <span class="keywordtype">size_t</span> count)</div>
<div class="line">{</div>
<div class="line">    printk(KERN_INFO <span class="stringliteral">&quot;Received: %s\n&quot;</span>, buf);</div>
<div class="line">    <span class="keywordflow">return</span> count;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> DEVICE_ATTR(my_attr, 0644, my_show, my_store);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Or use helper macros</span></div>
<div class="line"><span class="keyword">static</span> DEVICE_ATTR_RO(my_attr);  <span class="comment">// Read-only</span></div>
<div class="line"><span class="keyword">static</span> DEVICE_ATTR_WO(my_attr);  <span class="comment">// Write-only</span></div>
<div class="line"><span class="keyword">static</span> DEVICE_ATTR_RW(my_attr);  <span class="comment">// Read-write</span></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md415"></a>
Creating Attributes</h2>
<div class="fragment"><div class="line"><span class="comment">// Single attribute</span></div>
<div class="line"><span class="keywordtype">int</span> device_create_file(<span class="keyword">struct</span> device *dev, <span class="keyword">const</span> <span class="keyword">struct</span> device_attribute *attr);</div>
<div class="line"><span class="keywordtype">void</span> device_remove_file(<span class="keyword">struct</span> device *dev, <span class="keyword">const</span> <span class="keyword">struct</span> device_attribute *attr);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Example</span></div>
<div class="line">device_create_file(my_device, &amp;dev_attr_my_attr);</div>
<div class="line">device_remove_file(my_device, &amp;dev_attr_my_attr);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md416"></a>
Attribute Groups</h2>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>attribute *my_attrs[] = {</div>
<div class="line">    &amp;dev_attr_attr1.attr,</div>
<div class="line">    &amp;dev_attr_attr2.attr,</div>
<div class="line">    &amp;dev_attr_attr3.attr,</div>
<div class="line">    NULL,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>attribute_group my_attr_group = {</div>
<div class="line">    .name = <span class="stringliteral">&quot;my_group&quot;</span>,</div>
<div class="line">    .attrs = my_attrs,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create group</span></div>
<div class="line">sysfs_create_group(&amp;dev-&gt;kobj, &amp;my_attr_group);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Remove group</span></div>
<div class="line">sysfs_remove_group(&amp;dev-&gt;kobj, &amp;my_attr_group);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md417"></a>
Example</h2>
<div class="fragment"><div class="line"><span class="keyword">struct </span>my_device {</div>
<div class="line">    <span class="keyword">struct </span>device dev;</div>
<div class="line">    <span class="keywordtype">int</span> value;</div>
<div class="line">    <span class="keywordtype">char</span> name[32];</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> ssize_t value_show(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_attribute *attr, <span class="keywordtype">char</span> *buf)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>my_device *mydev = container_of(dev, <span class="keyword">struct</span> my_device, dev);</div>
<div class="line">    <span class="keywordflow">return</span> sprintf(buf, <span class="stringliteral">&quot;%d\n&quot;</span>, mydev-&gt;value);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> ssize_t value_store(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_attribute *attr,</div>
<div class="line">                          <span class="keyword">const</span> <span class="keywordtype">char</span> *buf, <span class="keywordtype">size_t</span> count)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>my_device *mydev = container_of(dev, <span class="keyword">struct</span> my_device, dev);</div>
<div class="line">    sscanf(buf, <span class="stringliteral">&quot;%d&quot;</span>, &amp;mydev-&gt;value);</div>
<div class="line">    <span class="keywordflow">return</span> count;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> ssize_t name_show(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_attribute *attr, <span class="keywordtype">char</span> *buf)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>my_device *mydev = container_of(dev, <span class="keyword">struct</span> my_device, dev);</div>
<div class="line">    <span class="keywordflow">return</span> sprintf(buf, <span class="stringliteral">&quot;%s\n&quot;</span>, mydev-&gt;name);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> DEVICE_ATTR_RW(value);</div>
<div class="line"><span class="keyword">static</span> DEVICE_ATTR_RO(name);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>attribute *my_device_attrs[] = {</div>
<div class="line">    &amp;dev_attr_value.attr,</div>
<div class="line">    &amp;dev_attr_name.attr,</div>
<div class="line">    NULL,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">ATTRIBUTE_GROUPS(my_device);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md418"></a>
Driver Data</h1>
<p>Store private data with device.</p>
<div class="fragment"><div class="line"><span class="comment">// Set driver data</span></div>
<div class="line"><span class="keywordtype">void</span> dev_set_drvdata(<span class="keyword">struct</span> device *dev, <span class="keywordtype">void</span> *data);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Get driver data</span></div>
<div class="line"><span class="keywordtype">void</span> *dev_get_drvdata(<span class="keyword">const</span> <span class="keyword">struct</span> device *dev);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Example</span></div>
<div class="line"><span class="keyword">struct </span>my_private_data {</div>
<div class="line">    <span class="keywordtype">int</span> value;</div>
<div class="line">    <span class="keywordtype">void</span> *buffer;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> my_probe(<span class="keyword">struct</span> device *dev)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>my_private_data *priv;</div>
<div class="line">    </div>
<div class="line">    priv = devm_kzalloc(dev, <span class="keyword">sizeof</span>(*priv), GFP_KERNEL);</div>
<div class="line">    <span class="keywordflow">if</span> (!priv)</div>
<div class="line">        <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line">    </div>
<div class="line">    priv-&gt;value = 42;</div>
<div class="line">    dev_set_drvdata(dev, priv);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> my_remove(<span class="keyword">struct</span> device *dev)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>my_private_data *priv = dev_get_drvdata(dev);</div>
<div class="line">    </div>
<div class="line">    printk(KERN_INFO <span class="stringliteral">&quot;Value: %d\n&quot;</span>, priv-&gt;value);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md419"></a>
Power Management</h1>
<h2><a class="anchor" id="autotoc_md420"></a>
PM Operations</h2>
<div class="fragment"><div class="line"><span class="keyword">struct </span>dev_pm_ops {</div>
<div class="line">    int (*suspend)(<span class="keyword">struct </span>device *dev);</div>
<div class="line">    int (*resume)(<span class="keyword">struct </span>device *dev);</div>
<div class="line">    int (*freeze)(<span class="keyword">struct </span>device *dev);</div>
<div class="line">    int (*thaw)(<span class="keyword">struct </span>device *dev);</div>
<div class="line">    int (*poweroff)(<span class="keyword">struct </span>device *dev);</div>
<div class="line">    int (*restore)(<span class="keyword">struct </span>device *dev);</div>
<div class="line">    int (*runtime_suspend)(<span class="keyword">struct </span>device *dev);</div>
<div class="line">    int (*runtime_resume)(<span class="keyword">struct </span>device *dev);</div>
<div class="line">    int (*runtime_idle)(<span class="keyword">struct </span>device *dev);</div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md421"></a>
Example</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#ifdef CONFIG_PM</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> my_suspend(<span class="keyword">struct</span> device *dev)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>my_device *mydev = dev_get_drvdata(dev);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Save device state</span></div>
<div class="line">    <span class="comment">// Disable clocks, power down</span></div>
<div class="line">    </div>
<div class="line">    dev_info(dev, <span class="stringliteral">&quot;Device suspended\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> my_resume(<span class="keyword">struct</span> device *dev)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>my_device *mydev = dev_get_drvdata(dev);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Restore device state</span></div>
<div class="line">    <span class="comment">// Enable clocks, power up</span></div>
<div class="line">    </div>
<div class="line">    dev_info(dev, <span class="stringliteral">&quot;Device resumed\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span>dev_pm_ops my_pm_ops = {</div>
<div class="line">    .suspend = my_suspend,</div>
<div class="line">    .resume = my_resume,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define MY_PM_OPS (&amp;my_pm_ops)</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor">#define MY_PM_OPS NULL</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>platform_driver my_driver = {</div>
<div class="line">    .driver = {</div>
<div class="line">        .name = <span class="stringliteral">&quot;mydevice&quot;</span>,</div>
<div class="line">        .pm = MY_PM_OPS,</div>
<div class="line">    },</div>
<div class="line">};</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md422"></a>
Runtime PM</h1>
<p>Dynamic power management.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/pm_runtime.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Enable runtime PM</span></div>
<div class="line">pm_runtime_enable(dev);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Disable runtime PM</span></div>
<div class="line">pm_runtime_disable(dev);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Get device (increment usage count)</span></div>
<div class="line">pm_runtime_get_sync(dev);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Put device (decrement usage count)</span></div>
<div class="line">pm_runtime_put(dev);</div>
<div class="line">pm_runtime_put_sync(dev);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Mark as active/suspended</span></div>
<div class="line">pm_runtime_set_active(dev);</div>
<div class="line">pm_runtime_set_suspended(dev);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md423"></a>
Complete Example</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/module.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/platform_device.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/device.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>my_device {</div>
<div class="line">    <span class="keyword">struct </span>device dev;</div>
<div class="line">    <span class="keywordtype">int</span> value;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> my_device_release(<span class="keyword">struct</span> device *dev)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>my_device *mydev = container_of(dev, <span class="keyword">struct</span> my_device, dev);</div>
<div class="line">    kfree(mydev);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> ssize_t value_show(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_attribute *attr, <span class="keywordtype">char</span> *buf)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>my_device *mydev = container_of(dev, <span class="keyword">struct</span> my_device, dev);</div>
<div class="line">    <span class="keywordflow">return</span> sprintf(buf, <span class="stringliteral">&quot;%d\n&quot;</span>, mydev-&gt;value);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> ssize_t value_store(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_attribute *attr,</div>
<div class="line">                          <span class="keyword">const</span> <span class="keywordtype">char</span> *buf, <span class="keywordtype">size_t</span> count)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>my_device *mydev = container_of(dev, <span class="keyword">struct</span> my_device, dev);</div>
<div class="line">    sscanf(buf, <span class="stringliteral">&quot;%d&quot;</span>, &amp;mydev-&gt;value);</div>
<div class="line">    <span class="keywordflow">return</span> count;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> DEVICE_ATTR_RW(value);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>attribute *my_device_attrs[] = {</div>
<div class="line">    &amp;dev_attr_value.attr,</div>
<div class="line">    NULL,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">ATTRIBUTE_GROUPS(my_device);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>class my_class = {</div>
<div class="line">    .name = <span class="stringliteral">&quot;my_class&quot;</span>,</div>
<div class="line">    .owner = THIS_MODULE,</div>
<div class="line">    .dev_groups = my_device_groups,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> __init driver_model_init(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>my_device *mydev;</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Register class</span></div>
<div class="line">    ret = class_register(&amp;my_class);</div>
<div class="line">    <span class="keywordflow">if</span> (ret) {</div>
<div class="line">        printk(KERN_ERR <span class="stringliteral">&quot;Failed to register class\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> ret;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Create device</span></div>
<div class="line">    mydev = kzalloc(<span class="keyword">sizeof</span>(*mydev), GFP_KERNEL);</div>
<div class="line">    <span class="keywordflow">if</span> (!mydev) {</div>
<div class="line">        class_unregister(&amp;my_class);</div>
<div class="line">        <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    mydev-&gt;value = 42;</div>
<div class="line">    mydev-&gt;dev.class = &amp;my_class;</div>
<div class="line">    mydev-&gt;dev.release = my_device_release;</div>
<div class="line">    dev_set_name(&amp;mydev-&gt;dev, <span class="stringliteral">&quot;mydevice0&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    ret = device_register(&amp;mydev-&gt;dev);</div>
<div class="line">    <span class="keywordflow">if</span> (ret) {</div>
<div class="line">        kfree(mydev);</div>
<div class="line">        class_unregister(&amp;my_class);</div>
<div class="line">        <span class="keywordflow">return</span> ret;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    printk(KERN_INFO <span class="stringliteral">&quot;Driver model initialized\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> __exit driver_model_exit(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    class_unregister(&amp;my_class);</div>
<div class="line">    printk(KERN_INFO <span class="stringliteral">&quot;Driver model exited\n&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">module_init(driver_model_init);</div>
<div class="line">module_exit(driver_model_exit);</div>
<div class="line"> </div>
<div class="line">MODULE_LICENSE(<span class="stringliteral">&quot;GPL&quot;</span>);</div>
<div class="line">MODULE_DESCRIPTION(<span class="stringliteral">&quot;Linux driver model example&quot;</span>);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md424"></a>
Sysfs Hierarchy</h1>
<div class="fragment"><div class="line">/sys/</div>
<div class="line">├── bus/           # Buses</div>
<div class="line">│   └── platform/</div>
<div class="line">│       ├── devices/</div>
<div class="line">│       └── drivers/</div>
<div class="line">├── class/         # Device classes</div>
<div class="line">│   └── myclass/</div>
<div class="line">│       └── mydevice/</div>
<div class="line">├── devices/       # All devices</div>
<div class="line">│   └── platform/</div>
<div class="line">└── module/        # Loaded modules</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md425"></a>
Best Practices</h1>
<ol type="1">
<li><b>Use device model</b> for proper integration</li>
<li><b>Implement power management</b> for mobile devices</li>
<li><b>Provide sysfs attributes</b> for configuration</li>
<li><b>Use managed resources</b> (devm_*)</li>
<li><b>Follow naming conventions</b></li>
<li><b>Document sysfs interface</b></li>
<li><b>Handle hotplug</b> properly</li>
<li><b>Test with different configurations</b></li>
</ol>
<h1><a class="anchor" id="autotoc_md426"></a>
Next Steps</h1>
<p>Proceed to <a class="el" href="md_13-driver-debugging-techniques.html">Driver Debugging Techniques</a> to learn about debugging kernel drivers. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri Feb 13 2026 16:02:32 for Linux Driver Development Manual by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
