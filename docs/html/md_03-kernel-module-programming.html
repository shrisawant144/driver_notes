<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Linux Driver Development Manual: Linux Kernel Module Programming</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Linux Driver Development Manual
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">Comprehensive guide to Linux kernel and device driver development</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Linux Kernel Module Programming </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md119"></a>
Overview</h1>
<p>Kernel modules are pieces of code that can be loaded and unloaded into the kernel on demand, extending kernel functionality without rebooting. This chapter covers the fundamentals of writing, compiling, and managing kernel modules.</p>
<h1><a class="anchor" id="autotoc_md120"></a>
What is a Kernel Module?</h1>
<ul>
<li>Dynamically loadable code that runs in kernel space</li>
<li>Extends kernel functionality without recompilation</li>
<li>Can be loaded/unloaded at runtime</li>
<li>Has full access to kernel resources</li>
<li>No memory protection (bugs can crash system)</li>
</ul>
<h1><a class="anchor" id="autotoc_md121"></a>
Advantages of Modules</h1>
<ul>
<li><b>Dynamic loading</b>: Add features without reboot</li>
<li><b>Reduced memory</b>: Load only needed modules</li>
<li><b>Easier development</b>: Test without kernel rebuild</li>
<li><b>Maintainability</b>: Modular code organization</li>
</ul>
<h1><a class="anchor" id="autotoc_md122"></a>
Hello World Module</h1>
<h2><a class="anchor" id="autotoc_md123"></a>
Basic Module Structure</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/module.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/kernel.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/init.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> __init hello_init(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    printk(KERN_INFO <span class="stringliteral">&quot;Hello, World!\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> __exit hello_exit(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    printk(KERN_INFO <span class="stringliteral">&quot;Goodbye, World!\n&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">module_init(hello_init);</div>
<div class="line">module_exit(hello_exit);</div>
<div class="line"> </div>
<div class="line">MODULE_LICENSE(<span class="stringliteral">&quot;GPL&quot;</span>);</div>
<div class="line">MODULE_AUTHOR(<span class="stringliteral">&quot;Your Name&quot;</span>);</div>
<div class="line">MODULE_DESCRIPTION(<span class="stringliteral">&quot;A simple Hello World module&quot;</span>);</div>
<div class="line">MODULE_VERSION(<span class="stringliteral">&quot;1.0&quot;</span>);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md124"></a>
Makefile</h2>
<div class="fragment"><div class="line">obj-m += hello.o</div>
<div class="line"> </div>
<div class="line">KDIR := /lib/modules/$(shell uname -r)/build</div>
<div class="line">PWD := $(shell pwd)</div>
<div class="line"> </div>
<div class="line">all:</div>
<div class="line">    make -C $(KDIR) M=$(PWD) modules</div>
<div class="line"> </div>
<div class="line">clean:</div>
<div class="line">    make -C $(KDIR) M=$(PWD) clean</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md125"></a>
Building the Module</h2>
<div class="fragment"><div class="line">make</div>
</div><!-- fragment --><p>Output files:</p><ul>
<li><code>hello.ko</code>: Kernel object (loadable module)</li>
<li><code>hello.mod.c</code>: Generated module metadata</li>
<li><code>hello.o</code>: Object file</li>
</ul>
<h2><a class="anchor" id="autotoc_md126"></a>
Loading and Unloading</h2>
<div class="fragment"><div class="line"># Load module</div>
<div class="line">sudo insmod hello.ko</div>
<div class="line"> </div>
<div class="line"># View kernel messages</div>
<div class="line">dmesg | tail</div>
<div class="line"> </div>
<div class="line"># List loaded modules</div>
<div class="line">lsmod | grep hello</div>
<div class="line"> </div>
<div class="line"># Module information</div>
<div class="line">modinfo hello.ko</div>
<div class="line"> </div>
<div class="line"># Unload module</div>
<div class="line">sudo rmmod hello</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md127"></a>
Module Macros</h1>
<h2><a class="anchor" id="autotoc_md128"></a>
Initialization and Cleanup</h2>
<div class="fragment"><div class="line">module_init(init_function);  <span class="comment">// Called when module loaded</span></div>
<div class="line">module_exit(exit_function);  <span class="comment">// Called when module unloaded</span></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md129"></a>
Module Information</h2>
<div class="fragment"><div class="line">MODULE_LICENSE(<span class="stringliteral">&quot;GPL&quot;</span>);              <span class="comment">// License type</span></div>
<div class="line">MODULE_AUTHOR(<span class="stringliteral">&quot;Author Name&quot;</span>);       <span class="comment">// Author</span></div>
<div class="line">MODULE_DESCRIPTION(<span class="stringliteral">&quot;Description&quot;</span>);  <span class="comment">// Description</span></div>
<div class="line">MODULE_VERSION(<span class="stringliteral">&quot;1.0&quot;</span>);              <span class="comment">// Version</span></div>
<div class="line">MODULE_ALIAS(<span class="stringliteral">&quot;alias_name&quot;</span>);         <span class="comment">// Alias name</span></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md130"></a>
License Types</h2>
<ul>
<li><code>"GPL"</code>: GNU Public License</li>
<li><code>"GPL v2"</code>: GPL version 2</li>
<li><code>"Dual BSD/GPL"</code>: Dual licensed</li>
<li><code>"Proprietary"</code>: Closed source (taints kernel)</li>
</ul>
<h1><a class="anchor" id="autotoc_md131"></a>
Kernel Logging</h1>
<h2><a class="anchor" id="autotoc_md132"></a>
printk Function</h2>
<div class="fragment"><div class="line">printk(KERN_LEVEL <span class="stringliteral">&quot;message&quot;</span>);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md133"></a>
Log Levels</h2>
<div class="fragment"><div class="line">KERN_EMERG    <span class="comment">// System is unusable</span></div>
<div class="line">KERN_ALERT    <span class="comment">// Action must be taken immediately</span></div>
<div class="line">KERN_CRIT     <span class="comment">// Critical conditions</span></div>
<div class="line">KERN_ERR      <span class="comment">// Error conditions</span></div>
<div class="line">KERN_WARNING  <span class="comment">// Warning conditions</span></div>
<div class="line">KERN_NOTICE   <span class="comment">// Normal but significant</span></div>
<div class="line">KERN_INFO     <span class="comment">// Informational</span></div>
<div class="line">KERN_DEBUG    <span class="comment">// Debug-level messages</span></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md134"></a>
Example</h2>
<div class="fragment"><div class="line">printk(KERN_INFO <span class="stringliteral">&quot;Module loaded successfully\n&quot;</span>);</div>
<div class="line">printk(KERN_ERR <span class="stringliteral">&quot;Error: Failed to allocate memory\n&quot;</span>);</div>
<div class="line">printk(KERN_DEBUG <span class="stringliteral">&quot;Debug: Variable value = %d\n&quot;</span>, value);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md135"></a>
Viewing Logs</h2>
<div class="fragment"><div class="line">dmesg                    # View all kernel messages</div>
<div class="line">dmesg | tail -20         # Last 20 messages</div>
<div class="line">dmesg -w                 # Watch mode (follow)</div>
<div class="line">dmesg -l err             # Only errors</div>
<div class="line">journalctl -k            # Kernel messages (systemd)</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md136"></a>
Module Parameters</h1>
<p>Allow passing arguments to modules at load time.</p>
<h2><a class="anchor" id="autotoc_md137"></a>
Defining Parameters</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/moduleparam.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> count = 1;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span> *name = <span class="stringliteral">&quot;default&quot;</span>;</div>
<div class="line"> </div>
<div class="line">module_param(count, <span class="keywordtype">int</span>, S_IRUGO);</div>
<div class="line">MODULE_PARM_DESC(count, <span class="stringliteral">&quot;Number of iterations&quot;</span>);</div>
<div class="line"> </div>
<div class="line">module_param(name, charp, S_IRUGO);</div>
<div class="line">MODULE_PARM_DESC(name, <span class="stringliteral">&quot;Name to display&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> __init param_init(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; count; i++) {</div>
<div class="line">        printk(KERN_INFO <span class="stringliteral">&quot;Hello %s (%d/%d)\n&quot;</span>, name, i+1, count);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md138"></a>
Parameter Types</h2>
<div class="fragment"><div class="line">module_param(name, type, permissions);</div>
</div><!-- fragment --><p>Types:</p><ul>
<li><code>int</code>, <code>uint</code>: Integer</li>
<li><code>long</code>, <code>ulong</code>: Long integer</li>
<li><code>short</code>, <code>ushort</code>: Short integer</li>
<li><code>bool</code>: Boolean</li>
<li><code>charp</code>: Character pointer (string)</li>
</ul>
<h2><a class="anchor" id="autotoc_md139"></a>
Permissions</h2>
<div class="fragment"><div class="line">S_IRUGO  <span class="comment">// Read by all</span></div>
<div class="line">S_IWUSR  <span class="comment">// Write by owner</span></div>
<div class="line">S_IRUSR  <span class="comment">// Read by owner</span></div>
<div class="line">0        <span class="comment">// No sysfs entry</span></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md140"></a>
Loading with Parameters</h2>
<div class="fragment"><div class="line">sudo insmod module.ko count=5 name=&quot;Linux&quot;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md141"></a>
Viewing Parameters</h2>
<div class="fragment"><div class="line"># Via sysfs</div>
<div class="line">cat /sys/module/module_name/parameters/count</div>
<div class="line"> </div>
<div class="line"># Via modinfo</div>
<div class="line">modinfo module.ko</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md142"></a>
Module Dependencies</h1>
<h2><a class="anchor" id="autotoc_md143"></a>
Exporting Symbols</h2>
<div class="fragment"><div class="line"><span class="comment">// module1.c</span></div>
<div class="line"><span class="keywordtype">int</span> shared_function(<span class="keywordtype">int</span> x)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> x * 2;</div>
<div class="line">}</div>
<div class="line">EXPORT_SYMBOL(shared_function);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> shared_var = 100;</div>
<div class="line">EXPORT_SYMBOL(shared_var);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md144"></a>
Using Exported Symbols</h2>
<div class="fragment"><div class="line"><span class="comment">// module2.c</span></div>
<div class="line"><span class="keyword">extern</span> <span class="keywordtype">int</span> shared_function(<span class="keywordtype">int</span> x);</div>
<div class="line"><span class="keyword">extern</span> <span class="keywordtype">int</span> shared_var;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> __init mod2_init(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> result = shared_function(5);</div>
<div class="line">    printk(KERN_INFO <span class="stringliteral">&quot;Result: %d, Var: %d\n&quot;</span>, result, shared_var);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md145"></a>
Export Types</h2>
<div class="fragment"><div class="line">EXPORT_SYMBOL(symbol);         <span class="comment">// Export to all modules</span></div>
<div class="line">EXPORT_SYMBOL_GPL(symbol);     <span class="comment">// Export only to GPL modules</span></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md146"></a>
__init and __exit Macros</h1>
<h2><a class="anchor" id="autotoc_md147"></a>
Purpose</h2>
<ul>
<li>Mark functions for special handling</li>
<li>Memory optimization</li>
</ul>
<h2><a class="anchor" id="autotoc_md148"></a>
__init Macro</h2>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> __init my_init(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Initialization code</span></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><ul>
<li>Memory freed after initialization</li>
<li>Used for one-time setup code</li>
</ul>
<h2><a class="anchor" id="autotoc_md149"></a>
__exit Macro</h2>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> __exit my_exit(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Cleanup code</span></div>
<div class="line">}</div>
</div><!-- fragment --><ul>
<li>Omitted if module built into kernel</li>
<li>Used for cleanup code</li>
</ul>
<h2><a class="anchor" id="autotoc_md150"></a>
__initdata and __exitdata</h2>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> __initdata init_value = 100;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span> __exitdata exit_msg[] = <span class="stringliteral">&quot;Goodbye&quot;</span>;</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md151"></a>
Error Handling</h1>
<h2><a class="anchor" id="autotoc_md152"></a>
Return Values</h2>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> __init my_init(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line">    </div>
<div class="line">    ret = some_function();</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line">        printk(KERN_ERR <span class="stringliteral">&quot;Initialization failed: %d\n&quot;</span>, ret);</div>
<div class="line">        <span class="keywordflow">return</span> ret;  <span class="comment">// Return error code</span></div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;  <span class="comment">// Success</span></div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md153"></a>
Common Error Codes</h2>
<div class="fragment"><div class="line">-ENOMEM   <span class="comment">// Out of memory</span></div>
<div class="line">-EINVAL   <span class="comment">// Invalid argument</span></div>
<div class="line">-EBUSY    <span class="comment">// Device or resource busy</span></div>
<div class="line">-EIO      <span class="comment">// I/O error</span></div>
<div class="line">-ENODEV   <span class="comment">// No such device</span></div>
<div class="line">-EFAULT   <span class="comment">// Bad address</span></div>
<div class="line">-EPERM    <span class="comment">// Operation not permitted</span></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md154"></a>
Cleanup on Error</h2>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> __init my_init(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line">    <span class="keywordtype">void</span> *ptr1, *ptr2;</div>
<div class="line">    </div>
<div class="line">    ptr1 = kmalloc(100, GFP_KERNEL);</div>
<div class="line">    <span class="keywordflow">if</span> (!ptr1)</div>
<div class="line">        <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line">    </div>
<div class="line">    ptr2 = kmalloc(200, GFP_KERNEL);</div>
<div class="line">    <span class="keywordflow">if</span> (!ptr2) {</div>
<div class="line">        ret = -ENOMEM;</div>
<div class="line">        <span class="keywordflow">goto</span> err_ptr2;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line"> </div>
<div class="line">err_ptr2:</div>
<div class="line">    kfree(ptr1);</div>
<div class="line">    <span class="keywordflow">return</span> ret;</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md155"></a>
Module Utilities</h1>
<h2><a class="anchor" id="autotoc_md156"></a>
insmod</h2>
<div class="fragment"><div class="line">sudo insmod module.ko [parameters]</div>
</div><!-- fragment --><ul>
<li>Loads module</li>
<li>No dependency resolution</li>
</ul>
<h2><a class="anchor" id="autotoc_md157"></a>
rmmod</h2>
<div class="fragment"><div class="line">sudo rmmod module_name</div>
</div><!-- fragment --><ul>
<li>Unloads module</li>
<li>Fails if module in use</li>
</ul>
<h2><a class="anchor" id="autotoc_md158"></a>
modprobe</h2>
<div class="fragment"><div class="line">sudo modprobe module_name [parameters]</div>
</div><!-- fragment --><ul>
<li>Loads module with dependencies</li>
<li>Searches standard locations</li>
</ul>
<div class="fragment"><div class="line">sudo modprobe -r module_name</div>
</div><!-- fragment --><ul>
<li>Removes module and unused dependencies</li>
</ul>
<h2><a class="anchor" id="autotoc_md159"></a>
lsmod</h2>
<div class="fragment"><div class="line">lsmod</div>
</div><!-- fragment --><ul>
<li>Lists loaded modules</li>
<li>Shows size and usage count</li>
</ul>
<h2><a class="anchor" id="autotoc_md160"></a>
modinfo</h2>
<div class="fragment"><div class="line">modinfo module.ko</div>
</div><!-- fragment --><ul>
<li>Shows module information</li>
<li>Parameters, author, license, etc.</li>
</ul>
<h2><a class="anchor" id="autotoc_md161"></a>
depmod</h2>
<div class="fragment"><div class="line">sudo depmod -a</div>
</div><!-- fragment --><ul>
<li>Generates module dependency database</li>
<li>Updates <code>/lib/modules/$(uname -r)/modules.dep</code></li>
</ul>
<h1><a class="anchor" id="autotoc_md162"></a>
Module Locations</h1>
<div class="fragment"><div class="line">/lib/modules/$(uname -r)/</div>
<div class="line">├── kernel/           # Kernel modules</div>
<div class="line">│   ├── drivers/</div>
<div class="line">│   ├── fs/</div>
<div class="line">│   ├── net/</div>
<div class="line">│   └── ...</div>
<div class="line">├── modules.dep       # Dependency information</div>
<div class="line">├── modules.alias     # Module aliases</div>
<div class="line">└── modules.symbols   # Exported symbols</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md163"></a>
Advanced Module Example</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/module.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/kernel.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/init.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/moduleparam.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> debug = 0;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> count = 1;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span> *message = <span class="stringliteral">&quot;Hello&quot;</span>;</div>
<div class="line"> </div>
<div class="line">module_param(debug, <span class="keywordtype">int</span>, S_IRUGO | S_IWUSR);</div>
<div class="line">MODULE_PARM_DESC(debug, <span class="stringliteral">&quot;Enable debug messages&quot;</span>);</div>
<div class="line"> </div>
<div class="line">module_param(count, <span class="keywordtype">int</span>, S_IRUGO);</div>
<div class="line">MODULE_PARM_DESC(count, <span class="stringliteral">&quot;Number of times to print message&quot;</span>);</div>
<div class="line"> </div>
<div class="line">module_param(message, charp, S_IRUGO);</div>
<div class="line">MODULE_PARM_DESC(message, <span class="stringliteral">&quot;Message to print&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> __init advanced_init(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line">    </div>
<div class="line">    printk(KERN_INFO <span class="stringliteral">&quot;Module loading...\n&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (debug)</div>
<div class="line">        printk(KERN_DEBUG <span class="stringliteral">&quot;Debug mode enabled\n&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (count &lt;= 0) {</div>
<div class="line">        printk(KERN_ERR <span class="stringliteral">&quot;Invalid count: %d\n&quot;</span>, count);</div>
<div class="line">        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; count; i++) {</div>
<div class="line">        printk(KERN_INFO <span class="stringliteral">&quot;[%d/%d] %s\n&quot;</span>, i+1, count, message);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    printk(KERN_INFO <span class="stringliteral">&quot;Module loaded successfully\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> __exit advanced_exit(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (debug)</div>
<div class="line">        printk(KERN_DEBUG <span class="stringliteral">&quot;Cleaning up...\n&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    printk(KERN_INFO <span class="stringliteral">&quot;Module unloaded\n&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">module_init(advanced_init);</div>
<div class="line">module_exit(advanced_exit);</div>
<div class="line"> </div>
<div class="line">MODULE_LICENSE(<span class="stringliteral">&quot;GPL&quot;</span>);</div>
<div class="line">MODULE_AUTHOR(<span class="stringliteral">&quot;Your Name&quot;</span>);</div>
<div class="line">MODULE_DESCRIPTION(<span class="stringliteral">&quot;Advanced module example&quot;</span>);</div>
<div class="line">MODULE_VERSION(<span class="stringliteral">&quot;1.0&quot;</span>);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md164"></a>
Multiple Source Files</h1>
<h2><a class="anchor" id="autotoc_md165"></a>
Makefile for Multiple Files</h2>
<div class="fragment"><div class="line">obj-m += mymodule.o</div>
<div class="line">mymodule-objs := main.o helper.o utils.o</div>
<div class="line"> </div>
<div class="line">KDIR := /lib/modules/$(shell uname -r)/build</div>
<div class="line"> </div>
<div class="line">all:</div>
<div class="line">    make -C $(KDIR) M=$(PWD) modules</div>
<div class="line"> </div>
<div class="line">clean:</div>
<div class="line">    make -C $(KDIR) M=$(PWD) clean</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md166"></a>
Kernel Version Compatibility</h1>
<h2><a class="anchor" id="autotoc_md167"></a>
Checking Kernel Version</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/version.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(5,0,0)</span></div>
<div class="line">    <span class="comment">// Code for kernel 5.0+</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">    <span class="comment">// Code for older kernels</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md168"></a>
Best Practices</h1>
<ol type="1">
<li><b>Always check return values</b></li>
<li><b>Clean up resources on error</b></li>
<li><b>Use appropriate log levels</b></li>
<li><b>Document module parameters</b></li>
<li><b>Handle module unload gracefully</b></li>
<li><b>Avoid blocking operations in init</b></li>
<li><b>Use GPL license when possible</b></li>
<li><b>Test thoroughly before deployment</b></li>
<li><b>Keep modules small and focused</b></li>
<li><b>Follow kernel coding style</b></li>
</ol>
<h1><a class="anchor" id="autotoc_md169"></a>
Common Pitfalls</h1>
<ul>
<li><b>Memory leaks</b>: Always free allocated memory</li>
<li><b>Unbalanced locks</b>: Match every lock with unlock</li>
<li><b>Sleeping in atomic context</b>: No blocking in interrupt handlers</li>
<li><b>Race conditions</b>: Proper synchronization needed</li>
<li><b>Unregistered resources</b>: Clean up everything in exit function</li>
</ul>
<h1><a class="anchor" id="autotoc_md170"></a>
Debugging Modules</h1>
<div class="fragment"><div class="line"># Enable dynamic debug</div>
<div class="line">echo &quot;module mymodule +p&quot; &gt; /sys/kernel/debug/dynamic_debug/control</div>
<div class="line"> </div>
<div class="line"># Check module load errors</div>
<div class="line">dmesg | grep -i error</div>
<div class="line"> </div>
<div class="line"># Verify module loaded</div>
<div class="line">lsmod | grep mymodule</div>
<div class="line"> </div>
<div class="line"># Check module usage</div>
<div class="line">cat /proc/modules</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md171"></a>
Next Steps</h1>
<p>Proceed to <a class="el" href="md_04-device-driver-programming.html">Linux Device Driver Programming</a> to learn about writing device drivers. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri Feb 13 2026 16:02:32 for Linux Driver Development Manual by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
