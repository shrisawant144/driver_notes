<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Linux Driver Development Manual: GPIO, SPI &amp; I2C Device Drivers</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Linux Driver Development Manual
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">Comprehensive guide to Linux kernel and device driver development</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">GPIO, SPI &amp; I2C Device Drivers </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md611"></a>
GPIO (General Purpose Input/Output)</h1>
<h2><a class="anchor" id="autotoc_md612"></a>
GPIO Descriptor Interface</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/gpio/consumer.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>gpio_desc *gpio;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Get GPIO</span></div>
<div class="line">gpio = gpiod_get(&amp;pdev-&gt;dev, <span class="stringliteral">&quot;reset&quot;</span>, GPIOD_OUT_LOW);</div>
<div class="line"><span class="keywordflow">if</span> (IS_ERR(gpio))</div>
<div class="line">    <span class="keywordflow">return</span> PTR_ERR(gpio);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Set value</span></div>
<div class="line">gpiod_set_value(gpio, 1);  <span class="comment">// High</span></div>
<div class="line">gpiod_set_value(gpio, 0);  <span class="comment">// Low</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Get value</span></div>
<div class="line"><span class="keywordtype">int</span> val = gpiod_get_value(gpio);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Direction</span></div>
<div class="line">gpiod_direction_input(gpio);</div>
<div class="line">gpiod_direction_output(gpio, 0);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Release</span></div>
<div class="line">gpiod_put(gpio);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md613"></a>
Legacy GPIO Interface</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/gpio.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> gpio_num = 17;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Request GPIO</span></div>
<div class="line"><span class="keywordflow">if</span> (gpio_request(gpio_num, <span class="stringliteral">&quot;my-gpio&quot;</span>) &lt; 0)</div>
<div class="line">    <span class="keywordflow">return</span> -EBUSY;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Direction</span></div>
<div class="line">gpio_direction_output(gpio_num, 0);</div>
<div class="line">gpio_direction_input(gpio_num);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Set/Get value</span></div>
<div class="line">gpio_set_value(gpio_num, 1);</div>
<div class="line"><span class="keywordtype">int</span> val = gpio_get_value(gpio_num);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Free GPIO</span></div>
<div class="line">gpio_free(gpio_num);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md614"></a>
GPIO Interrupts</h2>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> irq = gpiod_to_irq(gpio);</div>
<div class="line"> </div>
<div class="line">irqreturn_t gpio_irq_handler(<span class="keywordtype">int</span> irq, <span class="keywordtype">void</span> *dev_id)</div>
<div class="line">{</div>
<div class="line">    pr_info(<span class="stringliteral">&quot;GPIO interrupt triggered\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> IRQ_HANDLED;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">request_irq(irq, gpio_irq_handler,</div>
<div class="line">            IRQF_TRIGGER_RISING | IRQF_TRIGGER_FALLING,</div>
<div class="line">            <span class="stringliteral">&quot;gpio-irq&quot;</span>, dev);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Cleanup</span></div>
<div class="line">free_irq(irq, dev);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md615"></a>
I2C Drivers</h1>
<h2><a class="anchor" id="autotoc_md616"></a>
I2C Driver Structure</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/i2c.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span>i2c_device_id device_id[] = {</div>
<div class="line">    { <span class="stringliteral">&quot;my_device&quot;</span>, 0 },</div>
<div class="line">    { }</div>
<div class="line">};</div>
<div class="line">MODULE_DEVICE_TABLE(i2c, device_id);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span>of_device_id device_of_match[] = {</div>
<div class="line">    { .compatible = <span class="stringliteral">&quot;vendor,my-device&quot;</span> },</div>
<div class="line">    { }</div>
<div class="line">};</div>
<div class="line">MODULE_DEVICE_TABLE(of, device_of_match);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> device_probe(<span class="keyword">struct</span> i2c_client *client,</div>
<div class="line">                        <span class="keyword">const</span> <span class="keyword">struct</span> i2c_device_id *<span class="keywordtype">id</span>)</div>
<div class="line">{</div>
<div class="line">    pr_info(<span class="stringliteral">&quot;I2C device probed: addr=0x%02x\n&quot;</span>, client-&gt;addr);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> device_remove(<span class="keyword">struct</span> i2c_client *client)</div>
<div class="line">{</div>
<div class="line">    pr_info(<span class="stringliteral">&quot;I2C device removed\n&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>i2c_driver device_driver = {</div>
<div class="line">    .driver = {</div>
<div class="line">        .name = <span class="stringliteral">&quot;my_i2c_driver&quot;</span>,</div>
<div class="line">        .of_match_table = device_of_match,</div>
<div class="line">    },</div>
<div class="line">    .probe = device_probe,</div>
<div class="line">    .remove = device_remove,</div>
<div class="line">    .id_table = device_id,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">module_i2c_driver(device_driver);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md617"></a>
I2C Read/Write Operations</h2>
<div class="fragment"><div class="line"><span class="comment">// Write byte</span></div>
<div class="line"><span class="keywordtype">int</span> i2c_smbus_write_byte_data(<span class="keyword">struct</span> i2c_client *client,</div>
<div class="line">                               u8 command, u8 value);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Read byte</span></div>
<div class="line">s32 i2c_smbus_read_byte_data(<span class="keyword">struct</span> i2c_client *client, u8 command);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Write word</span></div>
<div class="line"><span class="keywordtype">int</span> i2c_smbus_write_word_data(<span class="keyword">struct</span> i2c_client *client,</div>
<div class="line">                               u8 command, u16 value);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Read word</span></div>
<div class="line">s32 i2c_smbus_read_word_data(<span class="keyword">struct</span> i2c_client *client, u8 command);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Block write</span></div>
<div class="line"><span class="keywordtype">int</span> i2c_smbus_write_i2c_block_data(<span class="keyword">struct</span> i2c_client *client,</div>
<div class="line">                                    u8 command, u8 length,</div>
<div class="line">                                    <span class="keyword">const</span> u8 *values);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Block read</span></div>
<div class="line"><span class="keywordtype">int</span> i2c_smbus_read_i2c_block_data(<span class="keyword">struct</span> i2c_client *client,</div>
<div class="line">                                   u8 command, u8 length, u8 *values);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md618"></a>
I2C Transfer</h2>
<div class="fragment"><div class="line"><span class="keyword">struct </span>i2c_msg msgs[2];</div>
<div class="line">u8 reg = 0x10;</div>
<div class="line">u8 data[4];</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Write then read</span></div>
<div class="line">msgs[0].addr = client-&gt;addr;</div>
<div class="line">msgs[0].flags = 0;  <span class="comment">// Write</span></div>
<div class="line">msgs[0].len = 1;</div>
<div class="line">msgs[0].buf = &amp;reg;</div>
<div class="line"> </div>
<div class="line">msgs[1].addr = client-&gt;addr;</div>
<div class="line">msgs[1].flags = I2C_M_RD;  <span class="comment">// Read</span></div>
<div class="line">msgs[1].len = <span class="keyword">sizeof</span>(data);</div>
<div class="line">msgs[1].buf = data;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> ret = i2c_transfer(client-&gt;adapter, msgs, 2);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md619"></a>
Example: I2C EEPROM Driver</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/module.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/i2c.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>eeprom_dev {</div>
<div class="line">    <span class="keyword">struct </span>i2c_client *client;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> ssize_t eeprom_read(<span class="keyword">struct</span> file *file, <span class="keywordtype">char</span> __user *buf,</div>
<div class="line">                           <span class="keywordtype">size_t</span> count, loff_t *offset)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>eeprom_dev *dev = file-&gt;private_data;</div>
<div class="line">    u8 data[256];</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (*offset &gt;= 256)</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    <span class="keywordflow">if</span> (*offset + count &gt; 256)</div>
<div class="line">        count = 256 - *offset;</div>
<div class="line">    </div>
<div class="line">    ret = i2c_smbus_read_i2c_block_data(dev-&gt;client, *offset,</div>
<div class="line">                                        count, data);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">        <span class="keywordflow">return</span> ret;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (copy_to_user(buf, data, count))</div>
<div class="line">        <span class="keywordflow">return</span> -EFAULT;</div>
<div class="line">    </div>
<div class="line">    *offset += count;</div>
<div class="line">    <span class="keywordflow">return</span> count;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> eeprom_probe(<span class="keyword">struct</span> i2c_client *client,</div>
<div class="line">                        <span class="keyword">const</span> <span class="keyword">struct</span> i2c_device_id *<span class="keywordtype">id</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>eeprom_dev *dev;</div>
<div class="line">    </div>
<div class="line">    dev = devm_kzalloc(&amp;client-&gt;dev, <span class="keyword">sizeof</span>(*dev), GFP_KERNEL);</div>
<div class="line">    <span class="keywordflow">if</span> (!dev)</div>
<div class="line">        <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line">    </div>
<div class="line">    dev-&gt;client = client;</div>
<div class="line">    i2c_set_clientdata(client, dev);</div>
<div class="line">    </div>
<div class="line">    pr_info(<span class="stringliteral">&quot;EEPROM device probed\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> eeprom_remove(<span class="keyword">struct</span> i2c_client *client)</div>
<div class="line">{</div>
<div class="line">    pr_info(<span class="stringliteral">&quot;EEPROM device removed\n&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span>i2c_device_id eeprom_id[] = {</div>
<div class="line">    { <span class="stringliteral">&quot;eeprom_24c02&quot;</span>, 0 },</div>
<div class="line">    { }</div>
<div class="line">};</div>
<div class="line">MODULE_DEVICE_TABLE(i2c, eeprom_id);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>i2c_driver eeprom_driver = {</div>
<div class="line">    .driver = {</div>
<div class="line">        .name = <span class="stringliteral">&quot;eeprom_driver&quot;</span>,</div>
<div class="line">    },</div>
<div class="line">    .probe = eeprom_probe,</div>
<div class="line">    .remove = eeprom_remove,</div>
<div class="line">    .id_table = eeprom_id,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">module_i2c_driver(eeprom_driver);</div>
<div class="line">MODULE_LICENSE(<span class="stringliteral">&quot;GPL&quot;</span>);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md620"></a>
SPI Drivers</h1>
<h2><a class="anchor" id="autotoc_md621"></a>
SPI Driver Structure</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/spi/spi.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span>of_device_id spi_of_match[] = {</div>
<div class="line">    { .compatible = <span class="stringliteral">&quot;vendor,my-spi-device&quot;</span> },</div>
<div class="line">    { }</div>
<div class="line">};</div>
<div class="line">MODULE_DEVICE_TABLE(of, spi_of_match);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> spi_probe(<span class="keyword">struct</span> spi_device *spi)</div>
<div class="line">{</div>
<div class="line">    pr_info(<span class="stringliteral">&quot;SPI device probed: max_speed=%d Hz\n&quot;</span>, spi-&gt;max_speed_hz);</div>
<div class="line">    </div>
<div class="line">    spi-&gt;mode = SPI_MODE_0;</div>
<div class="line">    spi-&gt;bits_per_word = 8;</div>
<div class="line">    spi_setup(spi);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> spi_remove(<span class="keyword">struct</span> spi_device *spi)</div>
<div class="line">{</div>
<div class="line">    pr_info(<span class="stringliteral">&quot;SPI device removed\n&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>spi_driver spi_driver = {</div>
<div class="line">    .driver = {</div>
<div class="line">        .name = <span class="stringliteral">&quot;my_spi_driver&quot;</span>,</div>
<div class="line">        .of_match_table = spi_of_match,</div>
<div class="line">    },</div>
<div class="line">    .probe = spi_probe,</div>
<div class="line">    .remove = spi_remove,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">module_spi_driver(spi_driver);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md622"></a>
SPI Read/Write Operations</h2>
<div class="fragment"><div class="line"><span class="comment">// Simple write</span></div>
<div class="line"><span class="keywordtype">int</span> spi_write(<span class="keyword">struct</span> spi_device *spi, <span class="keyword">const</span> <span class="keywordtype">void</span> *buf, <span class="keywordtype">size_t</span> len);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Simple read</span></div>
<div class="line"><span class="keywordtype">int</span> spi_read(<span class="keyword">struct</span> spi_device *spi, <span class="keywordtype">void</span> *buf, <span class="keywordtype">size_t</span> len);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Write then read</span></div>
<div class="line"><span class="keywordtype">int</span> spi_write_then_read(<span class="keyword">struct</span> spi_device *spi,</div>
<div class="line">                        <span class="keyword">const</span> <span class="keywordtype">void</span> *txbuf, <span class="keywordtype">unsigned</span> n_tx,</div>
<div class="line">                        <span class="keywordtype">void</span> *rxbuf, <span class="keywordtype">unsigned</span> n_rx);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Synchronous transfer</span></div>
<div class="line"><span class="keyword">struct </span>spi_transfer xfer = {</div>
<div class="line">    .tx_buf = tx_data,</div>
<div class="line">    .rx_buf = rx_data,</div>
<div class="line">    .len = len,</div>
<div class="line">};</div>
<div class="line"><span class="keyword">struct </span>spi_message msg;</div>
<div class="line"> </div>
<div class="line">spi_message_init(&amp;msg);</div>
<div class="line">spi_message_add_tail(&amp;xfer, &amp;msg);</div>
<div class="line"><span class="keywordtype">int</span> ret = spi_sync(spi, &amp;msg);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md623"></a>
Example: SPI Flash Driver</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/module.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/spi/spi.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define CMD_READ  0x03</span></div>
<div class="line"><span class="preprocessor">#define CMD_WRITE 0x02</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>spi_flash {</div>
<div class="line">    <span class="keyword">struct </span>spi_device *spi;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> flash_read(<span class="keyword">struct</span> spi_flash *flash, u32 addr,</div>
<div class="line">                      <span class="keywordtype">void</span> *buf, <span class="keywordtype">size_t</span> len)</div>
<div class="line">{</div>
<div class="line">    u8 cmd[4];</div>
<div class="line">    </div>
<div class="line">    cmd[0] = CMD_READ;</div>
<div class="line">    cmd[1] = (addr &gt;&gt; 16) &amp; 0xFF;</div>
<div class="line">    cmd[2] = (addr &gt;&gt; 8) &amp; 0xFF;</div>
<div class="line">    cmd[3] = addr &amp; 0xFF;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> spi_write_then_read(flash-&gt;spi, cmd, 4, buf, len);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> flash_probe(<span class="keyword">struct</span> spi_device *spi)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>spi_flash *flash;</div>
<div class="line">    </div>
<div class="line">    flash = devm_kzalloc(&amp;spi-&gt;dev, <span class="keyword">sizeof</span>(*flash), GFP_KERNEL);</div>
<div class="line">    <span class="keywordflow">if</span> (!flash)</div>
<div class="line">        <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line">    </div>
<div class="line">    flash-&gt;spi = spi;</div>
<div class="line">    spi_set_drvdata(spi, flash);</div>
<div class="line">    </div>
<div class="line">    spi-&gt;mode = SPI_MODE_0;</div>
<div class="line">    spi-&gt;bits_per_word = 8;</div>
<div class="line">    spi_setup(spi);</div>
<div class="line">    </div>
<div class="line">    pr_info(<span class="stringliteral">&quot;SPI Flash probed\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> flash_remove(<span class="keyword">struct</span> spi_device *spi)</div>
<div class="line">{</div>
<div class="line">    pr_info(<span class="stringliteral">&quot;SPI Flash removed\n&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span>of_device_id flash_of_match[] = {</div>
<div class="line">    { .compatible = <span class="stringliteral">&quot;jedec,spi-nor&quot;</span> },</div>
<div class="line">    { }</div>
<div class="line">};</div>
<div class="line">MODULE_DEVICE_TABLE(of, flash_of_match);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>spi_driver flash_driver = {</div>
<div class="line">    .driver = {</div>
<div class="line">        .name = <span class="stringliteral">&quot;spi_flash&quot;</span>,</div>
<div class="line">        .of_match_table = flash_of_match,</div>
<div class="line">    },</div>
<div class="line">    .probe = flash_probe,</div>
<div class="line">    .remove = flash_remove,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">module_spi_driver(flash_driver);</div>
<div class="line">MODULE_LICENSE(<span class="stringliteral">&quot;GPL&quot;</span>);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md624"></a>
Device Tree Bindings</h1>
<h2><a class="anchor" id="autotoc_md625"></a>
GPIO in Device Tree</h2>
<div class="fragment"><div class="line">my_device {</div>
<div class="line">    compatible = &quot;vendor,my-device&quot;;</div>
<div class="line">    reset-gpios = &lt;&amp;gpio 17 GPIO_ACTIVE_HIGH&gt;;</div>
<div class="line">    enable-gpios = &lt;&amp;gpio 27 GPIO_ACTIVE_LOW&gt;;</div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md626"></a>
I2C in Device Tree</h2>
<div class="fragment"><div class="line">&amp;i2c1 {</div>
<div class="line">    status = &quot;okay&quot;;</div>
<div class="line">    </div>
<div class="line">    my_device@50 {</div>
<div class="line">        compatible = &quot;vendor,my-device&quot;;</div>
<div class="line">        reg = &lt;0x50&gt;;</div>
<div class="line">    };</div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md627"></a>
SPI in Device Tree</h2>
<div class="fragment"><div class="line">&amp;spi0 {</div>
<div class="line">    status = &quot;okay&quot;;</div>
<div class="line">    </div>
<div class="line">    my_device@0 {</div>
<div class="line">        compatible = &quot;vendor,my-spi-device&quot;;</div>
<div class="line">        reg = &lt;0&gt;;</div>
<div class="line">        spi-max-frequency = &lt;1000000&gt;;</div>
<div class="line">    };</div>
<div class="line">};</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md628"></a>
Best Practices</h1>
<ul>
<li>Use descriptor-based GPIO API for new code</li>
<li>Always check return values</li>
<li>Use devm_* functions for automatic cleanup</li>
<li>Implement proper error handling</li>
<li>Use device tree for hardware description</li>
<li>Handle device removal gracefully</li>
<li>Use appropriate transfer methods for performance</li>
<li>Implement power management when needed</li>
</ul>
<h1><a class="anchor" id="autotoc_md629"></a>
Debugging</h1>
<div class="fragment"><div class="line"># GPIO</div>
<div class="line">cat /sys/kernel/debug/gpio</div>
<div class="line"> </div>
<div class="line"># I2C</div>
<div class="line">i2cdetect -y 1</div>
<div class="line">i2cdump -y 1 0x50</div>
<div class="line">i2cget -y 1 0x50 0x00</div>
<div class="line"> </div>
<div class="line"># SPI</div>
<div class="line">cat /sys/class/spi_master/spi0/spi0.0/modalias</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri Feb 13 2026 16:02:34 for Linux Driver Development Manual by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
