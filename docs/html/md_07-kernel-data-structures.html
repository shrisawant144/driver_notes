<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Linux Driver Development Manual: Kernel Data Structures</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Linux Driver Development Manual
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">Comprehensive guide to Linux kernel and device driver development</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Kernel Data Structures </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md260"></a>
Overview</h1>
<p>The Linux kernel provides efficient, well-tested data structures for common programming tasks. Using these structures ensures compatibility, performance, and proper memory management.</p>
<h1><a class="anchor" id="autotoc_md261"></a>
Linked Lists</h1>
<h2><a class="anchor" id="autotoc_md262"></a>
Structure</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/list.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>list_head {</div>
<div class="line">    <span class="keyword">struct </span>list_head *next, *prev;</div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md263"></a>
Defining a List</h2>
<div class="fragment"><div class="line"><span class="keyword">struct </span>my_data {</div>
<div class="line">    <span class="keywordtype">int</span> value;</div>
<div class="line">    <span class="keywordtype">char</span> name[32];</div>
<div class="line">    <span class="keyword">struct </span>list_head list;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Static initialization</span></div>
<div class="line">LIST_HEAD(my_list);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Dynamic initialization</span></div>
<div class="line"><span class="keyword">struct </span>list_head my_list;</div>
<div class="line">INIT_LIST_HEAD(&amp;my_list);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md264"></a>
List Operations</h2>
<div class="fragment"><div class="line"><span class="comment">// Add to list</span></div>
<div class="line"><span class="keyword">struct </span>my_data *data = kmalloc(<span class="keyword">sizeof</span>(*data), GFP_KERNEL);</div>
<div class="line">data-&gt;value = 42;</div>
<div class="line">strcpy(data-&gt;name, <span class="stringliteral">&quot;example&quot;</span>);</div>
<div class="line">list_add(&amp;data-&gt;list, &amp;my_list);        <span class="comment">// Add to head</span></div>
<div class="line">list_add_tail(&amp;data-&gt;list, &amp;my_list);   <span class="comment">// Add to tail</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Delete from list</span></div>
<div class="line">list_del(&amp;data-&gt;list);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Check if empty</span></div>
<div class="line"><span class="keywordflow">if</span> (list_empty(&amp;my_list))</div>
<div class="line">    printk(<span class="stringliteral">&quot;List is empty\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Replace entry</span></div>
<div class="line">list_replace(&amp;old-&gt;list, &amp;new-&gt;list);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Move entry</span></div>
<div class="line">list_move(&amp;data-&gt;list, &amp;another_list);</div>
<div class="line">list_move_tail(&amp;data-&gt;list, &amp;another_list);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md265"></a>
Iterating Over Lists</h2>
<div class="fragment"><div class="line"><span class="keyword">struct </span>my_data *entry;</div>
<div class="line"><span class="keyword">struct </span>list_head *pos;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Basic iteration</span></div>
<div class="line">list_for_each(pos, &amp;my_list) {</div>
<div class="line">    entry = list_entry(pos, <span class="keyword">struct</span> my_data, list);</div>
<div class="line">    printk(<span class="stringliteral">&quot;Value: %d, Name: %s\n&quot;</span>, entry-&gt;value, entry-&gt;name);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Simpler iteration</span></div>
<div class="line">list_for_each_entry(entry, &amp;my_list, list) {</div>
<div class="line">    printk(<span class="stringliteral">&quot;Value: %d, Name: %s\n&quot;</span>, entry-&gt;value, entry-&gt;name);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Safe iteration (allows deletion)</span></div>
<div class="line"><span class="keyword">struct </span>my_data *tmp;</div>
<div class="line">list_for_each_entry_safe(entry, tmp, &amp;my_list, list) {</div>
<div class="line">    <span class="keywordflow">if</span> (entry-&gt;value == 0) {</div>
<div class="line">        list_del(&amp;entry-&gt;list);</div>
<div class="line">        kfree(entry);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Reverse iteration</span></div>
<div class="line">list_for_each_entry_reverse(entry, &amp;my_list, list) {</div>
<div class="line">    printk(<span class="stringliteral">&quot;Value: %d\n&quot;</span>, entry-&gt;value);</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md266"></a>
Complete Example</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/module.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/kernel.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/list.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/slab.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>person {</div>
<div class="line">    <span class="keywordtype">char</span> name[32];</div>
<div class="line">    <span class="keywordtype">int</span> age;</div>
<div class="line">    <span class="keyword">struct </span>list_head list;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> LIST_HEAD(person_list);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> __init list_init(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>person *p, *tmp;</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line">    <span class="keywordtype">char</span> *names[] = {<span class="stringliteral">&quot;Alice&quot;</span>, <span class="stringliteral">&quot;Bob&quot;</span>, <span class="stringliteral">&quot;Charlie&quot;</span>};</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Add entries</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++) {</div>
<div class="line">        p = kmalloc(<span class="keyword">sizeof</span>(*p), GFP_KERNEL);</div>
<div class="line">        strcpy(p-&gt;name, names[i]);</div>
<div class="line">        p-&gt;age = 20 + i * 5;</div>
<div class="line">        list_add_tail(&amp;p-&gt;list, &amp;person_list);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Print entries</span></div>
<div class="line">    list_for_each_entry(p, &amp;person_list, list) {</div>
<div class="line">        printk(KERN_INFO <span class="stringliteral">&quot;%s, age %d\n&quot;</span>, p-&gt;name, p-&gt;age);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> __exit list_exit(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>person *p, *tmp;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Clean up</span></div>
<div class="line">    list_for_each_entry_safe(p, tmp, &amp;person_list, list) {</div>
<div class="line">        list_del(&amp;p-&gt;list);</div>
<div class="line">        kfree(p);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    printk(KERN_INFO <span class="stringliteral">&quot;List cleaned up\n&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">module_init(list_init);</div>
<div class="line">module_exit(list_exit);</div>
<div class="line">MODULE_LICENSE(<span class="stringliteral">&quot;GPL&quot;</span>);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md267"></a>
Hash Lists (hlist)</h1>
<p>Optimized for hash tables with single pointer head.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/list.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>hlist_head {</div>
<div class="line">    <span class="keyword">struct </span>hlist_node *first;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>hlist_node {</div>
<div class="line">    <span class="keyword">struct </span>hlist_node *next, **pprev;</div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md268"></a>
Usage</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#define HASH_SIZE 256</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>my_hash_entry {</div>
<div class="line">    <span class="keywordtype">int</span> key;</div>
<div class="line">    <span class="keywordtype">char</span> data[64];</div>
<div class="line">    <span class="keyword">struct </span>hlist_node node;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>hlist_head hash_table[HASH_SIZE];</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> hash_init(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; HASH_SIZE; i++)</div>
<div class="line">        INIT_HLIST_HEAD(&amp;hash_table[i]);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> hash_func(<span class="keywordtype">int</span> key)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> key % HASH_SIZE;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> hash_add(<span class="keywordtype">int</span> key, <span class="keyword">const</span> <span class="keywordtype">char</span> *data)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>my_hash_entry *entry;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> hash;</div>
<div class="line">    </div>
<div class="line">    entry = kmalloc(<span class="keyword">sizeof</span>(*entry), GFP_KERNEL);</div>
<div class="line">    entry-&gt;key = key;</div>
<div class="line">    strcpy(entry-&gt;data, data);</div>
<div class="line">    </div>
<div class="line">    hash = hash_func(key);</div>
<div class="line">    hlist_add_head(&amp;entry-&gt;node, &amp;hash_table[hash]);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>my_hash_entry *hash_find(<span class="keywordtype">int</span> key)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>my_hash_entry *entry;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> hash = hash_func(key);</div>
<div class="line">    </div>
<div class="line">    hlist_for_each_entry(entry, &amp;hash_table[hash], node) {</div>
<div class="line">        <span class="keywordflow">if</span> (entry-&gt;key == key)</div>
<div class="line">            <span class="keywordflow">return</span> entry;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md269"></a>
Queues (kfifo)</h1>
<p>Circular buffer implementation.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/kfifo.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Define kfifo</span></div>
<div class="line">DEFINE_KFIFO(my_fifo, <span class="keywordtype">char</span>, 128);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Or dynamic allocation</span></div>
<div class="line"><span class="keyword">struct </span>kfifo my_fifo;</div>
<div class="line">kfifo_alloc(&amp;my_fifo, 128, GFP_KERNEL);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Put data</span></div>
<div class="line"><span class="keywordtype">char</span> data[] = <span class="stringliteral">&quot;Hello&quot;</span>;</div>
<div class="line">kfifo_in(&amp;my_fifo, data, strlen(data));</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Get data</span></div>
<div class="line"><span class="keywordtype">char</span> buffer[64];</div>
<div class="line"><span class="keywordtype">int</span> len = kfifo_out(&amp;my_fifo, buffer, <span class="keyword">sizeof</span>(buffer));</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Peek without removing</span></div>
<div class="line">len = kfifo_out_peek(&amp;my_fifo, buffer, <span class="keyword">sizeof</span>(buffer));</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Check status</span></div>
<div class="line"><span class="keywordflow">if</span> (kfifo_is_empty(&amp;my_fifo))</div>
<div class="line">    printk(<span class="stringliteral">&quot;FIFO is empty\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">if</span> (kfifo_is_full(&amp;my_fifo))</div>
<div class="line">    printk(<span class="stringliteral">&quot;FIFO is full\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> avail = kfifo_avail(&amp;my_fifo);</div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> len = kfifo_len(&amp;my_fifo);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Reset</span></div>
<div class="line">kfifo_reset(&amp;my_fifo);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Free</span></div>
<div class="line">kfifo_free(&amp;my_fifo);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md270"></a>
Red-Black Trees</h1>
<p>Self-balancing binary search tree.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/rbtree.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>my_node {</div>
<div class="line">    <span class="keywordtype">int</span> key;</div>
<div class="line">    <span class="keywordtype">char</span> data[64];</div>
<div class="line">    <span class="keyword">struct </span>rb_node node;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>rb_root my_tree = RB_ROOT;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> my_insert(<span class="keyword">struct</span> rb_root *root, <span class="keyword">struct</span> my_node *data)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>rb_node **<span class="keyword">new</span> = &amp;(root-&gt;rb_node), *parent = NULL;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">while</span> (*<span class="keyword">new</span>) {</div>
<div class="line">        <span class="keyword">struct </span>my_node *<span class="keyword">this</span> = rb_entry(*<span class="keyword">new</span>, <span class="keyword">struct</span> my_node, node);</div>
<div class="line">        </div>
<div class="line">        parent = *<span class="keyword">new</span>;</div>
<div class="line">        <span class="keywordflow">if</span> (data-&gt;key &lt; this-&gt;key)</div>
<div class="line">            <span class="keyword">new</span> = &amp;((*new)-&gt;rb_left);</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (data-&gt;key &gt; this-&gt;key)</div>
<div class="line">            <span class="keyword">new</span> = &amp;((*new)-&gt;rb_right);</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">            <span class="keywordflow">return</span> -1;  <span class="comment">// Duplicate</span></div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    rb_link_node(&amp;data-&gt;node, parent, <span class="keyword">new</span>);</div>
<div class="line">    rb_insert_color(&amp;data-&gt;node, root);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>my_node *my_search(<span class="keyword">struct</span> rb_root *root, <span class="keywordtype">int</span> key)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>rb_node *node = root-&gt;rb_node;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">while</span> (node) {</div>
<div class="line">        <span class="keyword">struct </span>my_node *data = rb_entry(node, <span class="keyword">struct</span> my_node, node);</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">if</span> (key &lt; data-&gt;key)</div>
<div class="line">            node = node-&gt;rb_left;</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (key &gt; data-&gt;key)</div>
<div class="line">            node = node-&gt;rb_right;</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">            <span class="keywordflow">return</span> data;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> my_delete(<span class="keyword">struct</span> rb_root *root, <span class="keyword">struct</span> my_node *data)</div>
<div class="line">{</div>
<div class="line">    rb_erase(&amp;data-&gt;node, root);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Iterate</span></div>
<div class="line"><span class="keyword">struct </span>rb_node *node;</div>
<div class="line"><span class="keywordflow">for</span> (node = rb_first(&amp;my_tree); node; node = rb_next(node)) {</div>
<div class="line">    <span class="keyword">struct </span>my_node *data = rb_entry(node, <span class="keyword">struct</span> my_node, node);</div>
<div class="line">    printk(<span class="stringliteral">&quot;Key: %d\n&quot;</span>, data-&gt;key);</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md271"></a>
Bitmaps</h1>
<p>Efficient bit manipulation.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/bitmap.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define BITS 256</span></div>
<div class="line"> </div>
<div class="line">DECLARE_BITMAP(my_bitmap, BITS);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Set bit</span></div>
<div class="line">set_bit(5, my_bitmap);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Clear bit</span></div>
<div class="line">clear_bit(5, my_bitmap);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Test bit</span></div>
<div class="line"><span class="keywordflow">if</span> (test_bit(5, my_bitmap))</div>
<div class="line">    printk(<span class="stringliteral">&quot;Bit 5 is set\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Test and set</span></div>
<div class="line"><span class="keywordflow">if</span> (test_and_set_bit(5, my_bitmap))</div>
<div class="line">    printk(<span class="stringliteral">&quot;Bit was already set\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Find first zero bit</span></div>
<div class="line"><span class="keywordtype">int</span> bit = find_first_zero_bit(my_bitmap, BITS);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Find next set bit</span></div>
<div class="line">bit = find_next_bit(my_bitmap, BITS, 0);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Clear all bits</span></div>
<div class="line">bitmap_zero(my_bitmap, BITS);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Set all bits</span></div>
<div class="line">bitmap_fill(my_bitmap, BITS);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Copy bitmap</span></div>
<div class="line">DECLARE_BITMAP(copy, BITS);</div>
<div class="line">bitmap_copy(copy, my_bitmap, BITS);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md272"></a>
IDR (ID Radix Tree)</h1>
<p>Maps integers to pointers.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/idr.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> DEFINE_IDR(my_idr);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Allocate ID and store pointer</span></div>
<div class="line"><span class="keyword">struct </span>my_data *data = kmalloc(<span class="keyword">sizeof</span>(*data), GFP_KERNEL);</div>
<div class="line"><span class="keywordtype">int</span> <span class="keywordtype">id</span> = idr_alloc(&amp;my_idr, data, 0, 0, GFP_KERNEL);</div>
<div class="line"><span class="keywordflow">if</span> (<span class="keywordtype">id</span> &lt; 0) {</div>
<div class="line">    kfree(data);</div>
<div class="line">    <span class="keywordflow">return</span> id;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Lookup</span></div>
<div class="line">data = idr_find(&amp;my_idr, <span class="keywordtype">id</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Remove</span></div>
<div class="line">idr_remove(&amp;my_idr, <span class="keywordtype">id</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Iterate</span></div>
<div class="line"><span class="keywordtype">int</span> id;</div>
<div class="line"><span class="keyword">struct </span>my_data *entry;</div>
<div class="line">idr_for_each_entry(&amp;my_idr, entry, <span class="keywordtype">id</span>) {</div>
<div class="line">    printk(<span class="stringliteral">&quot;ID: %d\n&quot;</span>, <span class="keywordtype">id</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Destroy</span></div>
<div class="line">idr_destroy(&amp;my_idr);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md273"></a>
Work Queues</h1>
<p>Deferred work execution.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/workqueue.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>my_work {</div>
<div class="line">    <span class="keyword">struct </span>work_struct work;</div>
<div class="line">    <span class="keywordtype">int</span> data;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> my_work_handler(<span class="keyword">struct</span> work_struct *work)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>my_work *my = container_of(work, <span class="keyword">struct</span> my_work, work);</div>
<div class="line">    printk(<span class="stringliteral">&quot;Work executed with data: %d\n&quot;</span>, my-&gt;data);</div>
<div class="line">    kfree(my);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Schedule work</span></div>
<div class="line"><span class="keyword">struct </span>my_work *work = kmalloc(<span class="keyword">sizeof</span>(*work), GFP_KERNEL);</div>
<div class="line">work-&gt;data = 42;</div>
<div class="line">INIT_WORK(&amp;work-&gt;work, my_work_handler);</div>
<div class="line">schedule_work(&amp;work-&gt;work);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Delayed work</span></div>
<div class="line">DECLARE_DELAYED_WORK(my_delayed_work, my_work_handler);</div>
<div class="line">schedule_delayed_work(&amp;my_delayed_work, msecs_to_jiffies(1000));</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Cancel work</span></div>
<div class="line">cancel_work_sync(&amp;work-&gt;work);</div>
<div class="line">cancel_delayed_work_sync(&amp;my_delayed_work);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md274"></a>
Kernel Linked List Example</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/module.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/kernel.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/list.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/slab.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>student {</div>
<div class="line">    <span class="keywordtype">int</span> id;</div>
<div class="line">    <span class="keywordtype">char</span> name[32];</div>
<div class="line">    <span class="keywordtype">int</span> grade;</div>
<div class="line">    <span class="keyword">struct </span>list_head list;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> LIST_HEAD(student_list);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> add_student(<span class="keywordtype">int</span> <span class="keywordtype">id</span>, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">int</span> grade)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>student *s = kmalloc(<span class="keyword">sizeof</span>(*s), GFP_KERNEL);</div>
<div class="line">    s-&gt;id = id;</div>
<div class="line">    strcpy(s-&gt;name, name);</div>
<div class="line">    s-&gt;grade = grade;</div>
<div class="line">    list_add_tail(&amp;s-&gt;list, &amp;student_list);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> print_students(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>student *s;</div>
<div class="line">    printk(KERN_INFO <span class="stringliteral">&quot;Student List:\n&quot;</span>);</div>
<div class="line">    list_for_each_entry(s, &amp;student_list, list) {</div>
<div class="line">        printk(KERN_INFO <span class="stringliteral">&quot;ID: %d, Name: %s, Grade: %d\n&quot;</span>,</div>
<div class="line">               s-&gt;id, s-&gt;name, s-&gt;grade);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> remove_student(<span class="keywordtype">int</span> <span class="keywordtype">id</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>student *s, *tmp;</div>
<div class="line">    list_for_each_entry_safe(s, tmp, &amp;student_list, list) {</div>
<div class="line">        <span class="keywordflow">if</span> (s-&gt;id == <span class="keywordtype">id</span>) {</div>
<div class="line">            list_del(&amp;s-&gt;list);</div>
<div class="line">            kfree(s);</div>
<div class="line">            printk(KERN_INFO <span class="stringliteral">&quot;Removed student ID: %d\n&quot;</span>, <span class="keywordtype">id</span>);</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> cleanup_students(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>student *s, *tmp;</div>
<div class="line">    list_for_each_entry_safe(s, tmp, &amp;student_list, list) {</div>
<div class="line">        list_del(&amp;s-&gt;list);</div>
<div class="line">        kfree(s);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> __init data_struct_init(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    add_student(1, <span class="stringliteral">&quot;Alice&quot;</span>, 85);</div>
<div class="line">    add_student(2, <span class="stringliteral">&quot;Bob&quot;</span>, 90);</div>
<div class="line">    add_student(3, <span class="stringliteral">&quot;Charlie&quot;</span>, 78);</div>
<div class="line">    </div>
<div class="line">    print_students();</div>
<div class="line">    </div>
<div class="line">    remove_student(2);</div>
<div class="line">    </div>
<div class="line">    print_students();</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> __exit data_struct_exit(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    cleanup_students();</div>
<div class="line">    printk(KERN_INFO <span class="stringliteral">&quot;Module unloaded\n&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">module_init(data_struct_init);</div>
<div class="line">module_exit(data_struct_exit);</div>
<div class="line"> </div>
<div class="line">MODULE_LICENSE(<span class="stringliteral">&quot;GPL&quot;</span>);</div>
<div class="line">MODULE_DESCRIPTION(<span class="stringliteral">&quot;Kernel data structures example&quot;</span>);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md275"></a>
Comparison of Data Structures</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Structure </th><th class="markdownTableHeadNone">Use Case </th><th class="markdownTableHeadNone">Time Complexity  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Linked List </td><td class="markdownTableBodyNone">Sequential access, frequent insertion/deletion </td><td class="markdownTableBodyNone">O(n) search, O(1) insert/delete  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Hash List </td><td class="markdownTableBodyNone">Fast lookup by key </td><td class="markdownTableBodyNone">O(1) average  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Red-Black Tree </td><td class="markdownTableBodyNone">Sorted data, range queries </td><td class="markdownTableBodyNone">O(log n)  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Bitmap </td><td class="markdownTableBodyNone">Bit flags, resource allocation </td><td class="markdownTableBodyNone">O(1) per bit  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">kfifo </td><td class="markdownTableBodyNone">FIFO queue, circular buffer </td><td class="markdownTableBodyNone">O(1)  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">IDR </td><td class="markdownTableBodyNone">Integer to pointer mapping </td><td class="markdownTableBodyNone">O(log n)  </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md276"></a>
Best Practices</h1>
<ol type="1">
<li><b>Use kernel structures</b> instead of implementing your own</li>
<li><b>Choose appropriate structure</b> for your use case</li>
<li><b>Protect shared structures</b> with locks</li>
<li><b>Free memory</b> properly to avoid leaks</li>
<li><b>Use safe iterators</b> when modifying lists</li>
<li><b>Initialize structures</b> before use</li>
<li><b>Consider cache locality</b> for performance</li>
</ol>
<h1><a class="anchor" id="autotoc_md277"></a>
Next Steps</h1>
<p>Proceed to <a class="el" href="md_08-interrupt-handling.html">Interrupt Handling</a> to learn about handling hardware interrupts. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri Feb 13 2026 16:02:32 for Linux Driver Development Manual by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
