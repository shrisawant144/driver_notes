<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Linux Driver Development Manual: Linux Device Driver Programming</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Linux Driver Development Manual
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">Comprehensive guide to Linux kernel and device driver development</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Linux Device Driver Programming </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md173"></a>
Overview</h1>
<p>Device drivers are specialized kernel modules that provide an interface between hardware devices and the kernel. This chapter covers the fundamentals of device driver development in Linux.</p>
<h1><a class="anchor" id="autotoc_md174"></a>
Device Driver Types</h1>
<h2><a class="anchor" id="autotoc_md175"></a>
Character Devices</h2>
<ul>
<li>Stream of bytes (sequential access)</li>
<li>Examples: serial ports, keyboards, mice</li>
<li>Access via <code>/dev/ttyS0</code>, <code>/dev/input/mouse0</code></li>
</ul>
<h2><a class="anchor" id="autotoc_md176"></a>
Block Devices</h2>
<ul>
<li>Random access in fixed-size blocks</li>
<li>Examples: hard drives, USB drives, SD cards</li>
<li>Access via <code>/dev/sda</code>, <code>/dev/mmcblk0</code></li>
</ul>
<h2><a class="anchor" id="autotoc_md177"></a>
Network Devices</h2>
<ul>
<li>Network interfaces</li>
<li>Examples: Ethernet, WiFi</li>
<li>Access via <code>eth0</code>, <code>wlan0</code> (no device files)</li>
</ul>
<h1><a class="anchor" id="autotoc_md178"></a>
Device Numbers</h1>
<h2><a class="anchor" id="autotoc_md179"></a>
Major and Minor Numbers</h2>
<div class="fragment"><div class="line">Major Number: Identifies the driver</div>
<div class="line">Minor Number: Identifies the specific device</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md180"></a>
Viewing Device Numbers</h2>
<div class="fragment"><div class="line">ls -l /dev/</div>
<div class="line">crw-rw---- 1 root tty     4,  0 Feb 13 10:00 tty0</div>
<div class="line">brw-rw---- 1 root disk    8,  0 Feb 13 10:00 sda</div>
</div><!-- fragment --><p>Format: <code>major, minor</code></p>
<h2><a class="anchor" id="autotoc_md181"></a>
Allocating Device Numbers</h2>
<h3><a class="anchor" id="autotoc_md182"></a>
Static Allocation</h3>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/fs.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define MAJOR_NUM 240</span></div>
<div class="line"><span class="preprocessor">#define MINOR_NUM 0</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> major = MAJOR_NUM;</div>
<div class="line">dev_t dev = MKDEV(major, MINOR_NUM);</div>
<div class="line"> </div>
<div class="line">ret = register_chrdev_region(dev, 1, <span class="stringliteral">&quot;mydevice&quot;</span>);</div>
<div class="line"><span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line">    printk(KERN_ERR <span class="stringliteral">&quot;Failed to register device number\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> ret;</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md183"></a>
Dynamic Allocation</h3>
<div class="fragment"><div class="line">dev_t dev;</div>
<div class="line"><span class="keywordtype">int</span> ret;</div>
<div class="line"> </div>
<div class="line">ret = alloc_chrdev_region(&amp;dev, 0, 1, <span class="stringliteral">&quot;mydevice&quot;</span>);</div>
<div class="line"><span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line">    printk(KERN_ERR <span class="stringliteral">&quot;Failed to allocate device number\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> ret;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> major = MAJOR(dev);</div>
<div class="line"><span class="keywordtype">int</span> minor = MINOR(dev);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md184"></a>
Unregistering Device Numbers</h2>
<div class="fragment"><div class="line">unregister_chrdev_region(dev, 1);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md185"></a>
File Operations</h1>
<h2><a class="anchor" id="autotoc_md186"></a>
file_operations Structure</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/fs.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>file_operations fops = {</div>
<div class="line">    .owner = THIS_MODULE,</div>
<div class="line">    .open = device_open,</div>
<div class="line">    .release = device_release,</div>
<div class="line">    .read = device_read,</div>
<div class="line">    .write = device_write,</div>
<div class="line">    .llseek = device_llseek,</div>
<div class="line">    .unlocked_ioctl = device_ioctl,</div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md187"></a>
Common Operations</h2>
<div class="fragment"><div class="line">int (*open)(<span class="keyword">struct </span>inode *, <span class="keyword">struct </span>file *);</div>
<div class="line">int (*release)(<span class="keyword">struct </span>inode *, <span class="keyword">struct </span>file *);</div>
<div class="line">ssize_t (*read)(<span class="keyword">struct </span>file *, <span class="keywordtype">char</span> __user *, size_t, loff_t *);</div>
<div class="line">ssize_t (*write)(<span class="keyword">struct </span>file *, <span class="keyword">const</span> <span class="keywordtype">char</span> __user *, size_t, loff_t *);</div>
<div class="line">loff_t (*llseek)(<span class="keyword">struct </span>file *, loff_t, int);</div>
<div class="line">long (*unlocked_ioctl)(<span class="keyword">struct </span>file *, <span class="keywordtype">unsigned</span> int, <span class="keywordtype">unsigned</span> long);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md188"></a>
Character Device Registration</h1>
<h2><a class="anchor" id="autotoc_md189"></a>
Using cdev Structure</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/cdev.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>cdev my_cdev;</div>
<div class="line">dev_t dev;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Allocate device number</span></div>
<div class="line">alloc_chrdev_region(&amp;dev, 0, 1, <span class="stringliteral">&quot;mydevice&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Initialize cdev</span></div>
<div class="line">cdev_init(&amp;my_cdev, &amp;fops);</div>
<div class="line">my_cdev.owner = THIS_MODULE;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Add cdev to system</span></div>
<div class="line">ret = cdev_add(&amp;my_cdev, dev, 1);</div>
<div class="line"><span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line">    unregister_chrdev_region(dev, 1);</div>
<div class="line">    <span class="keywordflow">return</span> ret;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md190"></a>
Cleanup</h2>
<div class="fragment"><div class="line">cdev_del(&amp;my_cdev);</div>
<div class="line">unregister_chrdev_region(dev, 1);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md191"></a>
Implementing File Operations</h1>
<h2><a class="anchor" id="autotoc_md192"></a>
Open Function</h2>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> device_open(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</div>
<div class="line">{</div>
<div class="line">    printk(KERN_INFO <span class="stringliteral">&quot;Device opened\n&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Get device-specific data</span></div>
<div class="line">    <span class="keyword">struct </span>my_device *dev = container_of(inode-&gt;i_cdev, <span class="keyword">struct</span> my_device, cdev);</div>
<div class="line">    filp-&gt;private_data = dev;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md193"></a>
Release Function</h2>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> device_release(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</div>
<div class="line">{</div>
<div class="line">    printk(KERN_INFO <span class="stringliteral">&quot;Device closed\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md194"></a>
Read Function</h2>
<div class="fragment"><div class="line"><span class="keyword">static</span> ssize_t device_read(<span class="keyword">struct</span> file *filp, <span class="keywordtype">char</span> __user *buf, </div>
<div class="line">                          <span class="keywordtype">size_t</span> count, loff_t *f_pos)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> kernel_buf[100] = <span class="stringliteral">&quot;Hello from kernel&quot;</span>;</div>
<div class="line">    <span class="keywordtype">size_t</span> len = strlen(kernel_buf);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (*f_pos &gt;= len)</div>
<div class="line">        <span class="keywordflow">return</span> 0;  <span class="comment">// EOF</span></div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (*f_pos + count &gt; len)</div>
<div class="line">        count = len - *f_pos;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (copy_to_user(buf, kernel_buf + *f_pos, count))</div>
<div class="line">        <span class="keywordflow">return</span> -EFAULT;</div>
<div class="line">    </div>
<div class="line">    *f_pos += count;</div>
<div class="line">    <span class="keywordflow">return</span> count;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md195"></a>
Write Function</h2>
<div class="fragment"><div class="line"><span class="keyword">static</span> ssize_t device_write(<span class="keyword">struct</span> file *filp, <span class="keyword">const</span> <span class="keywordtype">char</span> __user *buf,</div>
<div class="line">                           <span class="keywordtype">size_t</span> count, loff_t *f_pos)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> kernel_buf[100];</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (count &gt; <span class="keyword">sizeof</span>(kernel_buf) - 1)</div>
<div class="line">        count = <span class="keyword">sizeof</span>(kernel_buf) - 1;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (copy_from_user(kernel_buf, buf, count))</div>
<div class="line">        <span class="keywordflow">return</span> -EFAULT;</div>
<div class="line">    </div>
<div class="line">    kernel_buf[count] = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line">    printk(KERN_INFO <span class="stringliteral">&quot;Received: %s\n&quot;</span>, kernel_buf);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> count;</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md196"></a>
User Space Data Transfer</h1>
<h2><a class="anchor" id="autotoc_md197"></a>
copy_to_user</h2>
<div class="fragment"><div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> copy_to_user(<span class="keywordtype">void</span> __user *to, <span class="keyword">const</span> <span class="keywordtype">void</span> *from, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> n);</div>
</div><!-- fragment --><p>Returns: Number of bytes that could not be copied (0 on success)</p>
<h2><a class="anchor" id="autotoc_md198"></a>
copy_from_user</h2>
<div class="fragment"><div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> copy_from_user(<span class="keywordtype">void</span> *to, <span class="keyword">const</span> <span class="keywordtype">void</span> __user *from, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> n);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md199"></a>
put_user and get_user</h2>
<div class="fragment"><div class="line"><span class="comment">// Copy single value to user space</span></div>
<div class="line">put_user(value, user_ptr);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Copy single value from user space</span></div>
<div class="line">get_user(value, user_ptr);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md200"></a>
Device Classes</h1>
<h2><a class="anchor" id="autotoc_md201"></a>
Creating Device Class</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/device.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>class *my_class;</div>
<div class="line"><span class="keyword">struct </span>device *my_device;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create class</span></div>
<div class="line">my_class = class_create(THIS_MODULE, <span class="stringliteral">&quot;myclass&quot;</span>);</div>
<div class="line"><span class="keywordflow">if</span> (IS_ERR(my_class)) {</div>
<div class="line">    unregister_chrdev_region(dev, 1);</div>
<div class="line">    <span class="keywordflow">return</span> PTR_ERR(my_class);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create device</span></div>
<div class="line">my_device = device_create(my_class, NULL, dev, NULL, <span class="stringliteral">&quot;mydevice&quot;</span>);</div>
<div class="line"><span class="keywordflow">if</span> (IS_ERR(my_device)) {</div>
<div class="line">    class_destroy(my_class);</div>
<div class="line">    unregister_chrdev_region(dev, 1);</div>
<div class="line">    <span class="keywordflow">return</span> PTR_ERR(my_device);</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md202"></a>
Cleanup</h2>
<div class="fragment"><div class="line">device_destroy(my_class, dev);</div>
<div class="line">class_destroy(my_class);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md203"></a>
Benefits</h2>
<ul>
<li>Automatic <code>/dev</code> node creation via udev</li>
<li>Sysfs entries for device information</li>
<li>Better device management</li>
</ul>
<h1><a class="anchor" id="autotoc_md204"></a>
Complete Character Driver Example</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/module.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/kernel.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/fs.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/cdev.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/device.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/uaccess.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define DEVICE_NAME &quot;mychardev&quot;</span></div>
<div class="line"><span class="preprocessor">#define CLASS_NAME &quot;myclass&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> dev_t dev_num;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>cdev my_cdev;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>class *my_class;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>device *my_device;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span> kernel_buffer[256];</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> buffer_size = 0;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> device_open(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</div>
<div class="line">{</div>
<div class="line">    printk(KERN_INFO <span class="stringliteral">&quot;Device opened\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> device_release(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</div>
<div class="line">{</div>
<div class="line">    printk(KERN_INFO <span class="stringliteral">&quot;Device closed\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> ssize_t device_read(<span class="keyword">struct</span> file *filp, <span class="keywordtype">char</span> __user *buf,</div>
<div class="line">                          <span class="keywordtype">size_t</span> count, loff_t *f_pos)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">size_t</span> to_read;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (*f_pos &gt;= buffer_size)</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    </div>
<div class="line">    to_read = min(count, (<span class="keywordtype">size_t</span>)(buffer_size - *f_pos));</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (copy_to_user(buf, kernel_buffer + *f_pos, to_read))</div>
<div class="line">        <span class="keywordflow">return</span> -EFAULT;</div>
<div class="line">    </div>
<div class="line">    *f_pos += to_read;</div>
<div class="line">    <span class="keywordflow">return</span> to_read;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> ssize_t device_write(<span class="keyword">struct</span> file *filp, <span class="keyword">const</span> <span class="keywordtype">char</span> __user *buf,</div>
<div class="line">                           <span class="keywordtype">size_t</span> count, loff_t *f_pos)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">size_t</span> to_write;</div>
<div class="line">    </div>
<div class="line">    to_write = min(count, <span class="keyword">sizeof</span>(kernel_buffer) - 1);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (copy_from_user(kernel_buffer, buf, to_write))</div>
<div class="line">        <span class="keywordflow">return</span> -EFAULT;</div>
<div class="line">    </div>
<div class="line">    kernel_buffer[to_write] = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line">    buffer_size = to_write;</div>
<div class="line">    </div>
<div class="line">    printk(KERN_INFO <span class="stringliteral">&quot;Received %zu bytes\n&quot;</span>, to_write);</div>
<div class="line">    <span class="keywordflow">return</span> to_write;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>file_operations fops = {</div>
<div class="line">    .owner = THIS_MODULE,</div>
<div class="line">    .open = device_open,</div>
<div class="line">    .release = device_release,</div>
<div class="line">    .read = device_read,</div>
<div class="line">    .write = device_write,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> __init chardev_init(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Allocate device number</span></div>
<div class="line">    ret = alloc_chrdev_region(&amp;dev_num, 0, 1, DEVICE_NAME);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line">        printk(KERN_ERR <span class="stringliteral">&quot;Failed to allocate device number\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> ret;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    printk(KERN_INFO <span class="stringliteral">&quot;Device number: Major=%d, Minor=%d\n&quot;</span>,</div>
<div class="line">           MAJOR(dev_num), MINOR(dev_num));</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Initialize and add cdev</span></div>
<div class="line">    cdev_init(&amp;my_cdev, &amp;fops);</div>
<div class="line">    my_cdev.owner = THIS_MODULE;</div>
<div class="line">    </div>
<div class="line">    ret = cdev_add(&amp;my_cdev, dev_num, 1);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line">        unregister_chrdev_region(dev_num, 1);</div>
<div class="line">        <span class="keywordflow">return</span> ret;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Create class</span></div>
<div class="line">    my_class = class_create(THIS_MODULE, CLASS_NAME);</div>
<div class="line">    <span class="keywordflow">if</span> (IS_ERR(my_class)) {</div>
<div class="line">        cdev_del(&amp;my_cdev);</div>
<div class="line">        unregister_chrdev_region(dev_num, 1);</div>
<div class="line">        <span class="keywordflow">return</span> PTR_ERR(my_class);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Create device</span></div>
<div class="line">    my_device = device_create(my_class, NULL, dev_num, NULL, DEVICE_NAME);</div>
<div class="line">    <span class="keywordflow">if</span> (IS_ERR(my_device)) {</div>
<div class="line">        class_destroy(my_class);</div>
<div class="line">        cdev_del(&amp;my_cdev);</div>
<div class="line">        unregister_chrdev_region(dev_num, 1);</div>
<div class="line">        <span class="keywordflow">return</span> PTR_ERR(my_device);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    printk(KERN_INFO <span class="stringliteral">&quot;Character device registered successfully\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> __exit chardev_exit(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    device_destroy(my_class, dev_num);</div>
<div class="line">    class_destroy(my_class);</div>
<div class="line">    cdev_del(&amp;my_cdev);</div>
<div class="line">    unregister_chrdev_region(dev_num, 1);</div>
<div class="line">    </div>
<div class="line">    printk(KERN_INFO <span class="stringliteral">&quot;Character device unregistered\n&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">module_init(chardev_init);</div>
<div class="line">module_exit(chardev_exit);</div>
<div class="line"> </div>
<div class="line">MODULE_LICENSE(<span class="stringliteral">&quot;GPL&quot;</span>);</div>
<div class="line">MODULE_AUTHOR(<span class="stringliteral">&quot;Your Name&quot;</span>);</div>
<div class="line">MODULE_DESCRIPTION(<span class="stringliteral">&quot;Simple character device driver&quot;</span>);</div>
<div class="line">MODULE_VERSION(<span class="stringliteral">&quot;1.0&quot;</span>);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md205"></a>
Testing the Driver</h1>
<h2><a class="anchor" id="autotoc_md206"></a>
User Space Test Program</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;fcntl.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> fd;</div>
<div class="line">    <span class="keywordtype">char</span> write_buf[] = <span class="stringliteral">&quot;Hello, Driver!&quot;</span>;</div>
<div class="line">    <span class="keywordtype">char</span> read_buf[256];</div>
<div class="line">    ssize_t ret;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Open device</span></div>
<div class="line">    fd = open(<span class="stringliteral">&quot;/dev/mychardev&quot;</span>, O_RDWR);</div>
<div class="line">    <span class="keywordflow">if</span> (fd &lt; 0) {</div>
<div class="line">        perror(<span class="stringliteral">&quot;Failed to open device&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Write to device</span></div>
<div class="line">    ret = write(fd, write_buf, strlen(write_buf));</div>
<div class="line">    printf(<span class="stringliteral">&quot;Wrote %zd bytes\n&quot;</span>, ret);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Reset file position</span></div>
<div class="line">    lseek(fd, 0, SEEK_SET);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Read from device</span></div>
<div class="line">    ret = read(fd, read_buf, <span class="keyword">sizeof</span>(read_buf));</div>
<div class="line">    <span class="keywordflow">if</span> (ret &gt; 0) {</div>
<div class="line">        read_buf[ret] = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line">        printf(<span class="stringliteral">&quot;Read %zd bytes: %s\n&quot;</span>, ret, read_buf);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Close device</span></div>
<div class="line">    close(fd);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md207"></a>
Compile and Run</h2>
<div class="fragment"><div class="line">gcc -o test test.c</div>
<div class="line">sudo ./test</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md208"></a>
IOCTL Operations</h1>
<h2><a class="anchor" id="autotoc_md209"></a>
Defining IOCTL Commands</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/ioctl.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define MAGIC_NUM &#39;M&#39;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define IOCTL_GET_VALUE _IOR(MAGIC_NUM, 0, int)</span></div>
<div class="line"><span class="preprocessor">#define IOCTL_SET_VALUE _IOW(MAGIC_NUM, 1, int)</span></div>
<div class="line"><span class="preprocessor">#define IOCTL_EXCHANGE  _IOWR(MAGIC_NUM, 2, int)</span></div>
</div><!-- fragment --><p>Macros:</p><ul>
<li><code>_IO(type, nr)</code>: No data transfer</li>
<li><code>_IOR(type, nr, datatype)</code>: Read from driver</li>
<li><code>_IOW(type, nr, datatype)</code>: Write to driver</li>
<li><code>_IOWR(type, nr, datatype)</code>: Read and write</li>
</ul>
<h2><a class="anchor" id="autotoc_md210"></a>
Implementing IOCTL</h2>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">long</span> device_ioctl(<span class="keyword">struct</span> file *filp, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cmd, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> arg)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> value;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">switch</span> (cmd) {</div>
<div class="line">    <span class="keywordflow">case</span> IOCTL_GET_VALUE:</div>
<div class="line">        value = 42;  <span class="comment">// Example value</span></div>
<div class="line">        <span class="keywordflow">if</span> (copy_to_user((<span class="keywordtype">int</span> __user *)arg, &amp;value, <span class="keyword">sizeof</span>(value)))</div>
<div class="line">            <span class="keywordflow">return</span> -EFAULT;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">        </div>
<div class="line">    <span class="keywordflow">case</span> IOCTL_SET_VALUE:</div>
<div class="line">        <span class="keywordflow">if</span> (copy_from_user(&amp;value, (<span class="keywordtype">int</span> __user *)arg, <span class="keyword">sizeof</span>(value)))</div>
<div class="line">            <span class="keywordflow">return</span> -EFAULT;</div>
<div class="line">        printk(KERN_INFO <span class="stringliteral">&quot;Received value: %d\n&quot;</span>, value);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">        </div>
<div class="line">    <span class="keywordflow">case</span> IOCTL_EXCHANGE:</div>
<div class="line">        <span class="keywordflow">if</span> (copy_from_user(&amp;value, (<span class="keywordtype">int</span> __user *)arg, <span class="keyword">sizeof</span>(value)))</div>
<div class="line">            <span class="keywordflow">return</span> -EFAULT;</div>
<div class="line">        value *= 2;  <span class="comment">// Process value</span></div>
<div class="line">        <span class="keywordflow">if</span> (copy_to_user((<span class="keywordtype">int</span> __user *)arg, &amp;value, <span class="keyword">sizeof</span>(value)))</div>
<div class="line">            <span class="keywordflow">return</span> -EFAULT;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">        </div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md211"></a>
User Space IOCTL</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;sys/ioctl.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> fd = open(<span class="stringliteral">&quot;/dev/mychardev&quot;</span>, O_RDWR);</div>
<div class="line"><span class="keywordtype">int</span> value;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Get value</span></div>
<div class="line">ioctl(fd, IOCTL_GET_VALUE, &amp;value);</div>
<div class="line">printf(<span class="stringliteral">&quot;Value: %d\n&quot;</span>, value);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Set value</span></div>
<div class="line">value = 100;</div>
<div class="line">ioctl(fd, IOCTL_SET_VALUE, &amp;value);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Exchange value</span></div>
<div class="line">value = 50;</div>
<div class="line">ioctl(fd, IOCTL_EXCHANGE, &amp;value);</div>
<div class="line">printf(<span class="stringliteral">&quot;Exchanged value: %d\n&quot;</span>, value);</div>
<div class="line"> </div>
<div class="line">close(fd);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md212"></a>
Sysfs Interface</h1>
<h2><a class="anchor" id="autotoc_md213"></a>
Creating Sysfs Attributes</h2>
<div class="fragment"><div class="line"><span class="keyword">static</span> ssize_t value_show(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_attribute *attr, <span class="keywordtype">char</span> *buf)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> sprintf(buf, <span class="stringliteral">&quot;%d\n&quot;</span>, my_value);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> ssize_t value_store(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_attribute *attr,</div>
<div class="line">                          <span class="keyword">const</span> <span class="keywordtype">char</span> *buf, <span class="keywordtype">size_t</span> count)</div>
<div class="line">{</div>
<div class="line">    sscanf(buf, <span class="stringliteral">&quot;%d&quot;</span>, &amp;my_value);</div>
<div class="line">    <span class="keywordflow">return</span> count;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> DEVICE_ATTR_RW(value);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>attribute *mydev_attrs[] = {</div>
<div class="line">    &amp;dev_attr_value.attr,</div>
<div class="line">    NULL,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>attribute_group mydev_attr_group = {</div>
<div class="line">    .attrs = mydev_attrs,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// In init function</span></div>
<div class="line">sysfs_create_group(&amp;my_device-&gt;kobj, &amp;mydev_attr_group);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// In exit function</span></div>
<div class="line">sysfs_remove_group(&amp;my_device-&gt;kobj, &amp;mydev_attr_group);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md214"></a>
Accessing Sysfs</h2>
<div class="fragment"><div class="line"># Read attribute</div>
<div class="line">cat /sys/class/myclass/mydevice/value</div>
<div class="line"> </div>
<div class="line"># Write attribute</div>
<div class="line">echo 42 &gt; /sys/class/myclass/mydevice/value</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md215"></a>
Procfs Interface</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/proc_fs.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/seq_file.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> my_proc_show(<span class="keyword">struct</span> seq_file *m, <span class="keywordtype">void</span> *v)</div>
<div class="line">{</div>
<div class="line">    seq_printf(m, <span class="stringliteral">&quot;Device status: OK\n&quot;</span>);</div>
<div class="line">    seq_printf(m, <span class="stringliteral">&quot;Value: %d\n&quot;</span>, my_value);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> my_proc_open(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> single_open(file, my_proc_show, NULL);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span>proc_ops my_proc_ops = {</div>
<div class="line">    .proc_open = my_proc_open,</div>
<div class="line">    .proc_read = seq_read,</div>
<div class="line">    .proc_lseek = seq_lseek,</div>
<div class="line">    .proc_release = single_release,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// In init function</span></div>
<div class="line">proc_create(<span class="stringliteral">&quot;mydevice&quot;</span>, 0, NULL, &amp;my_proc_ops);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// In exit function</span></div>
<div class="line">remove_proc_entry(<span class="stringliteral">&quot;mydevice&quot;</span>, NULL);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md216"></a>
Poll/Select Support</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/poll.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> device_poll(<span class="keyword">struct</span> file *filp, poll_table *wait)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> mask = 0;</div>
<div class="line">    </div>
<div class="line">    poll_wait(filp, &amp;my_wait_queue, wait);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (data_available)</div>
<div class="line">        mask |= POLLIN | POLLRDNORM;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (space_available)</div>
<div class="line">        mask |= POLLOUT | POLLWRNORM;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> mask;</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md217"></a>
Best Practices</h1>
<ol type="1">
<li><b>Always validate user input</b></li>
<li><b>Use proper error handling</b></li>
<li><b>Clean up resources in reverse order</b></li>
<li><b>Protect shared data with locks</b></li>
<li><b>Use copy_to_user/copy_from_user for user space data</b></li>
<li><b>Check return values of all functions</b></li>
<li><b>Provide meaningful error messages</b></li>
<li><b>Document driver interface</b></li>
</ol>
<h1><a class="anchor" id="autotoc_md218"></a>
Common Errors</h1>
<ul>
<li><b>Segmentation fault</b>: Invalid memory access</li>
<li><b>EFAULT</b>: Bad user space address</li>
<li><b>EINVAL</b>: Invalid argument</li>
<li><b>EBUSY</b>: Device already in use</li>
<li><b>ENOMEM</b>: Out of memory</li>
</ul>
<h1><a class="anchor" id="autotoc_md219"></a>
Next Steps</h1>
<p>Proceed to <a class="el" href="md_05-pseudo-char-device-driver.html">Pseudo Char Device Driver</a> for a practical implementation example. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri Feb 13 2026 16:02:32 for Linux Driver Development Manual by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
