<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Linux Driver Development Manual: IO Port Access</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Linux Driver Development Manual
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">Comprehensive guide to Linux kernel and device driver development</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">IO Port Access </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md366"></a>
Overview</h1>
<p>Hardware devices communicate with the CPU through I/O ports (port-mapped I/O) or memory-mapped I/O (MMIO). This chapter covers accessing hardware registers and I/O operations.</p>
<h1><a class="anchor" id="autotoc_md367"></a>
I/O Port vs Memory-Mapped I/O</h1>
<h2><a class="anchor" id="autotoc_md368"></a>
Port-Mapped I/O (x86)</h2>
<ul>
<li>Separate address space for I/O</li>
<li>Special CPU instructions (IN/OUT)</li>
<li>Limited address space (64KB on x86)</li>
</ul>
<h2><a class="anchor" id="autotoc_md369"></a>
Memory-Mapped I/O (Most architectures)</h2>
<ul>
<li>I/O registers mapped to memory addresses</li>
<li>Standard memory access instructions</li>
<li>Larger address space</li>
</ul>
<h1><a class="anchor" id="autotoc_md370"></a>
I/O Port Access (x86)</h1>
<h2><a class="anchor" id="autotoc_md371"></a>
Requesting I/O Ports</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/ioport.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Request port region</span></div>
<div class="line"><span class="keyword">struct </span>resource *request_region(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> start,</div>
<div class="line">                               <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> len,</div>
<div class="line">                               <span class="keyword">const</span> <span class="keywordtype">char</span> *name);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Release port region</span></div>
<div class="line"><span class="keywordtype">void</span> release_region(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> start, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> len);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Check if available</span></div>
<div class="line"><span class="keywordtype">int</span> check_region(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> start, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> len);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md372"></a>
Example</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#define PORT_BASE 0x300</span></div>
<div class="line"><span class="preprocessor">#define PORT_COUNT 8</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> __init port_init(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (!request_region(PORT_BASE, PORT_COUNT, <span class="stringliteral">&quot;mydevice&quot;</span>)) {</div>
<div class="line">        printk(KERN_ERR <span class="stringliteral">&quot;Failed to request I/O ports\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -EBUSY;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    printk(KERN_INFO <span class="stringliteral">&quot;I/O ports 0x%x-0x%x allocated\n&quot;</span>,</div>
<div class="line">           PORT_BASE, PORT_BASE + PORT_COUNT - 1);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> __exit port_exit(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    release_region(PORT_BASE, PORT_COUNT);</div>
<div class="line">    printk(KERN_INFO <span class="stringliteral">&quot;I/O ports released\n&quot;</span>);</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md373"></a>
Reading/Writing Ports</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;asm/io.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// 8-bit</span></div>
<div class="line">u8 inb(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> port);</div>
<div class="line"><span class="keywordtype">void</span> outb(u8 value, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> port);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 16-bit</span></div>
<div class="line">u16 inw(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> port);</div>
<div class="line"><span class="keywordtype">void</span> outw(u16 value, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> port);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 32-bit</span></div>
<div class="line">u32 inl(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> port);</div>
<div class="line"><span class="keywordtype">void</span> outl(u32 value, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> port);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// String operations</span></div>
<div class="line"><span class="keywordtype">void</span> insb(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> port, <span class="keywordtype">void</span> *addr, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> count);</div>
<div class="line"><span class="keywordtype">void</span> outsb(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> port, <span class="keyword">const</span> <span class="keywordtype">void</span> *addr, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> count);</div>
<div class="line"><span class="keywordtype">void</span> insw(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> port, <span class="keywordtype">void</span> *addr, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> count);</div>
<div class="line"><span class="keywordtype">void</span> outsw(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> port, <span class="keyword">const</span> <span class="keywordtype">void</span> *addr, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> count);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md374"></a>
Example</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#define DATA_PORT 0x300</span></div>
<div class="line"><span class="preprocessor">#define STATUS_PORT 0x301</span></div>
<div class="line"><span class="preprocessor">#define CONTROL_PORT 0x302</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> write_data(u8 data)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Wait until ready</span></div>
<div class="line">    <span class="keywordflow">while</span> (!(inb(STATUS_PORT) &amp; 0x01))</div>
<div class="line">        cpu_relax();</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Write data</span></div>
<div class="line">    outb(data, DATA_PORT);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> u8 read_data(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Wait for data available</span></div>
<div class="line">    <span class="keywordflow">while</span> (!(inb(STATUS_PORT) &amp; 0x02))</div>
<div class="line">        cpu_relax();</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Read data</span></div>
<div class="line">    <span class="keywordflow">return</span> inb(DATA_PORT);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> set_control(u8 flags)</div>
<div class="line">{</div>
<div class="line">    outb(flags, CONTROL_PORT);</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md375"></a>
Memory-Mapped I/O</h1>
<h2><a class="anchor" id="autotoc_md376"></a>
Requesting Memory Region</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/ioport.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Request memory region</span></div>
<div class="line"><span class="keyword">struct </span>resource *request_mem_region(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> start,</div>
<div class="line">                                   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> len,</div>
<div class="line">                                   <span class="keyword">const</span> <span class="keywordtype">char</span> *name);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Release memory region</span></div>
<div class="line"><span class="keywordtype">void</span> release_mem_region(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> start, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> len);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md377"></a>
Mapping Memory</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;asm/io.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Map I/O memory</span></div>
<div class="line"><span class="keywordtype">void</span> __iomem *ioremap(phys_addr_t phys_addr, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> size);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Unmap I/O memory</span></div>
<div class="line"><span class="keywordtype">void</span> iounmap(<span class="keywordtype">void</span> __iomem *addr);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Variants</span></div>
<div class="line"><span class="keywordtype">void</span> __iomem *ioremap_nocache(phys_addr_t phys_addr, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> size);</div>
<div class="line"><span class="keywordtype">void</span> __iomem *ioremap_wc(phys_addr_t phys_addr, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> size);  <span class="comment">// Write-combining</span></div>
<div class="line"><span class="keywordtype">void</span> __iomem *ioremap_wt(phys_addr_t phys_addr, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> size);  <span class="comment">// Write-through</span></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md378"></a>
Example</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#define MMIO_BASE 0x10000000</span></div>
<div class="line"><span class="preprocessor">#define MMIO_SIZE 0x1000</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> __iomem *base_addr;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> __init mmio_init(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Request memory region</span></div>
<div class="line">    <span class="keywordflow">if</span> (!request_mem_region(MMIO_BASE, MMIO_SIZE, <span class="stringliteral">&quot;mydevice&quot;</span>)) {</div>
<div class="line">        printk(KERN_ERR <span class="stringliteral">&quot;Failed to request memory region\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -EBUSY;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Map memory</span></div>
<div class="line">    base_addr = ioremap(MMIO_BASE, MMIO_SIZE);</div>
<div class="line">    <span class="keywordflow">if</span> (!base_addr) {</div>
<div class="line">        release_mem_region(MMIO_BASE, MMIO_SIZE);</div>
<div class="line">        <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    printk(KERN_INFO <span class="stringliteral">&quot;MMIO mapped at virtual address %p\n&quot;</span>, base_addr);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> __exit mmio_exit(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (base_addr) {</div>
<div class="line">        iounmap(base_addr);</div>
<div class="line">        release_mem_region(MMIO_BASE, MMIO_SIZE);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md379"></a>
Reading/Writing MMIO</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/io.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// 8-bit</span></div>
<div class="line">u8 ioread8(<span class="keyword">const</span> <span class="keyword">volatile</span> <span class="keywordtype">void</span> __iomem *addr);</div>
<div class="line"><span class="keywordtype">void</span> iowrite8(u8 value, <span class="keyword">volatile</span> <span class="keywordtype">void</span> __iomem *addr);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 16-bit</span></div>
<div class="line">u16 ioread16(<span class="keyword">const</span> <span class="keyword">volatile</span> <span class="keywordtype">void</span> __iomem *addr);</div>
<div class="line"><span class="keywordtype">void</span> iowrite16(u16 value, <span class="keyword">volatile</span> <span class="keywordtype">void</span> __iomem *addr);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 32-bit</span></div>
<div class="line">u32 ioread32(<span class="keyword">const</span> <span class="keyword">volatile</span> <span class="keywordtype">void</span> __iomem *addr);</div>
<div class="line"><span class="keywordtype">void</span> iowrite32(u32 value, <span class="keyword">volatile</span> <span class="keywordtype">void</span> __iomem *addr);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 64-bit</span></div>
<div class="line">u64 ioread64(<span class="keyword">const</span> <span class="keyword">volatile</span> <span class="keywordtype">void</span> __iomem *addr);</div>
<div class="line"><span class="keywordtype">void</span> iowrite64(u64 value, <span class="keyword">volatile</span> <span class="keywordtype">void</span> __iomem *addr);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Repeated access</span></div>
<div class="line"><span class="keywordtype">void</span> ioread8_rep(<span class="keyword">const</span> <span class="keyword">volatile</span> <span class="keywordtype">void</span> __iomem *addr, <span class="keywordtype">void</span> *buffer, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> count);</div>
<div class="line"><span class="keywordtype">void</span> iowrite8_rep(<span class="keyword">volatile</span> <span class="keywordtype">void</span> __iomem *addr, <span class="keyword">const</span> <span class="keywordtype">void</span> *buffer, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> count);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md380"></a>
Example</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#define REG_CONTROL  0x00</span></div>
<div class="line"><span class="preprocessor">#define REG_STATUS   0x04</span></div>
<div class="line"><span class="preprocessor">#define REG_DATA     0x08</span></div>
<div class="line"><span class="preprocessor">#define REG_INTERRUPT 0x0C</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>my_device {</div>
<div class="line">    <span class="keywordtype">void</span> __iomem *base;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> device_init_hw(<span class="keyword">struct</span> my_device *dev)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Reset device</span></div>
<div class="line">    iowrite32(0x01, dev-&gt;base + REG_CONTROL);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Wait for reset complete</span></div>
<div class="line">    <span class="keywordflow">while</span> (ioread32(dev-&gt;base + REG_STATUS) &amp; 0x01)</div>
<div class="line">        cpu_relax();</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Enable interrupts</span></div>
<div class="line">    iowrite32(0xFF, dev-&gt;base + REG_INTERRUPT);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> device_write_data(<span class="keyword">struct</span> my_device *dev, u32 data)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Check if ready</span></div>
<div class="line">    <span class="keywordflow">if</span> (!(ioread32(dev-&gt;base + REG_STATUS) &amp; 0x02)) {</div>
<div class="line">        printk(KERN_WARNING <span class="stringliteral">&quot;Device not ready\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Write data</span></div>
<div class="line">    iowrite32(data, dev-&gt;base + REG_DATA);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> u32 device_read_data(<span class="keyword">struct</span> my_device *dev)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> ioread32(dev-&gt;base + REG_DATA);</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md381"></a>
Memory Barriers</h1>
<p>Ensure proper ordering of I/O operations.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/io.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Memory barriers</span></div>
<div class="line">mb();   <span class="comment">// Full memory barrier</span></div>
<div class="line">rmb();  <span class="comment">// Read memory barrier</span></div>
<div class="line">wmb();  <span class="comment">// Write memory barrier</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// I/O barriers</span></div>
<div class="line">mmiowb();  <span class="comment">// MMIO write barrier</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Example</span></div>
<div class="line">iowrite32(value1, reg1);</div>
<div class="line">wmb();  <span class="comment">// Ensure write completes</span></div>
<div class="line">iowrite32(value2, reg2);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md382"></a>
Platform Device Resources</h1>
<h2><a class="anchor" id="autotoc_md383"></a>
Getting Resources</h2>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> my_probe(<span class="keyword">struct</span> platform_device *pdev)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>resource *res;</div>
<div class="line">    <span class="keywordtype">void</span> __iomem *base;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Get memory resource</span></div>
<div class="line">    res = platform_get_resource(pdev, IORESOURCE_MEM, 0);</div>
<div class="line">    <span class="keywordflow">if</span> (!res) {</div>
<div class="line">        dev_err(&amp;pdev-&gt;dev, <span class="stringliteral">&quot;No memory resource\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -ENODEV;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Request and map</span></div>
<div class="line">    <span class="keywordflow">if</span> (!request_mem_region(res-&gt;start, resource_size(res), pdev-&gt;name)) {</div>
<div class="line">        dev_err(&amp;pdev-&gt;dev, <span class="stringliteral">&quot;Memory region busy\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -EBUSY;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    base = ioremap(res-&gt;start, resource_size(res));</div>
<div class="line">    <span class="keywordflow">if</span> (!base) {</div>
<div class="line">        release_mem_region(res-&gt;start, resource_size(res));</div>
<div class="line">        <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Store for later use</span></div>
<div class="line">    platform_set_drvdata(pdev, base);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md384"></a>
Managed Resources</h2>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> my_probe(<span class="keyword">struct</span> platform_device *pdev)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>resource *res;</div>
<div class="line">    <span class="keywordtype">void</span> __iomem *base;</div>
<div class="line">    </div>
<div class="line">    res = platform_get_resource(pdev, IORESOURCE_MEM, 0);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Managed ioremap - automatically freed on detach</span></div>
<div class="line">    base = devm_ioremap_resource(&amp;pdev-&gt;dev, res);</div>
<div class="line">    <span class="keywordflow">if</span> (IS_ERR(base))</div>
<div class="line">        <span class="keywordflow">return</span> PTR_ERR(base);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// No need to call iounmap or release_mem_region</span></div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md385"></a>
Register Access Macros</h1>
<h2><a class="anchor" id="autotoc_md386"></a>
Defining Registers</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#define REG_CONTROL     0x00</span></div>
<div class="line"><span class="preprocessor">#define REG_STATUS      0x04</span></div>
<div class="line"><span class="preprocessor">#define REG_DATA        0x08</span></div>
<div class="line"><span class="preprocessor">#define REG_INTERRUPT   0x0C</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Bit definitions</span></div>
<div class="line"><span class="preprocessor">#define CONTROL_ENABLE  BIT(0)</span></div>
<div class="line"><span class="preprocessor">#define CONTROL_RESET   BIT(1)</span></div>
<div class="line"><span class="preprocessor">#define STATUS_READY    BIT(0)</span></div>
<div class="line"><span class="preprocessor">#define STATUS_ERROR    BIT(1)</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Helper macros</span></div>
<div class="line"><span class="preprocessor">#define REG_READ(dev, reg)          ioread32((dev)-&gt;base + (reg))</span></div>
<div class="line"><span class="preprocessor">#define REG_WRITE(dev, reg, val)    iowrite32((val), (dev)-&gt;base + (reg))</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define REG_SET_BIT(dev, reg, bit)  \</span></div>
<div class="line"><span class="preprocessor">    REG_WRITE(dev, reg, REG_READ(dev, reg) | (bit))</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define REG_CLEAR_BIT(dev, reg, bit) \</span></div>
<div class="line"><span class="preprocessor">    REG_WRITE(dev, reg, REG_READ(dev, reg) &amp; ~(bit))</span></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md387"></a>
Usage</h2>
<div class="fragment"><div class="line"><span class="keyword">struct </span>my_device {</div>
<div class="line">    <span class="keywordtype">void</span> __iomem *base;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> device_enable(<span class="keyword">struct</span> my_device *dev)</div>
<div class="line">{</div>
<div class="line">    REG_SET_BIT(dev, REG_CONTROL, CONTROL_ENABLE);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> device_reset(<span class="keyword">struct</span> my_device *dev)</div>
<div class="line">{</div>
<div class="line">    REG_SET_BIT(dev, REG_CONTROL, CONTROL_RESET);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Wait for reset complete</span></div>
<div class="line">    <span class="keywordflow">while</span> (REG_READ(dev, REG_STATUS) &amp; STATUS_READY)</div>
<div class="line">        cpu_relax();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> device_is_ready(<span class="keyword">struct</span> my_device *dev)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> REG_READ(dev, REG_STATUS) &amp; STATUS_READY;</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md388"></a>
Complete Example</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/module.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/platform_device.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/io.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/ioport.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define DEVICE_NAME &quot;mmio_device&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Register offsets</span></div>
<div class="line"><span class="preprocessor">#define REG_ID          0x00</span></div>
<div class="line"><span class="preprocessor">#define REG_CONTROL     0x04</span></div>
<div class="line"><span class="preprocessor">#define REG_STATUS      0x08</span></div>
<div class="line"><span class="preprocessor">#define REG_DATA        0x0C</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Control bits</span></div>
<div class="line"><span class="preprocessor">#define CTRL_ENABLE     BIT(0)</span></div>
<div class="line"><span class="preprocessor">#define CTRL_RESET      BIT(1)</span></div>
<div class="line"><span class="preprocessor">#define CTRL_IRQ_EN     BIT(2)</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Status bits</span></div>
<div class="line"><span class="preprocessor">#define STATUS_READY    BIT(0)</span></div>
<div class="line"><span class="preprocessor">#define STATUS_BUSY     BIT(1)</span></div>
<div class="line"><span class="preprocessor">#define STATUS_ERROR    BIT(2)</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>mmio_device {</div>
<div class="line">    <span class="keywordtype">void</span> __iomem *base;</div>
<div class="line">    <span class="keyword">struct </span>resource *mem_res;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> u32 mmio_read_reg(<span class="keyword">struct</span> mmio_device *dev, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> offset)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> ioread32(dev-&gt;base + offset);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> mmio_write_reg(<span class="keyword">struct</span> mmio_device *dev, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> offset, u32 value)</div>
<div class="line">{</div>
<div class="line">    iowrite32(value, dev-&gt;base + offset);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> mmio_device_init(<span class="keyword">struct</span> mmio_device *dev)</div>
<div class="line">{</div>
<div class="line">    u32 id;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Read device ID</span></div>
<div class="line">    <span class="keywordtype">id</span> = mmio_read_reg(dev, REG_ID);</div>
<div class="line">    printk(KERN_INFO <span class="stringliteral">&quot;Device ID: 0x%08x\n&quot;</span>, <span class="keywordtype">id</span>);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Reset device</span></div>
<div class="line">    mmio_write_reg(dev, REG_CONTROL, CTRL_RESET);</div>
<div class="line">    msleep(10);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Wait for ready</span></div>
<div class="line">    <span class="keywordflow">while</span> (!(mmio_read_reg(dev, REG_STATUS) &amp; STATUS_READY)) {</div>
<div class="line">        cpu_relax();</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Enable device</span></div>
<div class="line">    mmio_write_reg(dev, REG_CONTROL, CTRL_ENABLE | CTRL_IRQ_EN);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> mmio_probe(<span class="keyword">struct</span> platform_device *pdev)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>mmio_device *dev;</div>
<div class="line">    <span class="keyword">struct </span>resource *res;</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line">    </div>
<div class="line">    dev = devm_kzalloc(&amp;pdev-&gt;dev, <span class="keyword">sizeof</span>(*dev), GFP_KERNEL);</div>
<div class="line">    <span class="keywordflow">if</span> (!dev)</div>
<div class="line">        <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Get memory resource</span></div>
<div class="line">    res = platform_get_resource(pdev, IORESOURCE_MEM, 0);</div>
<div class="line">    <span class="keywordflow">if</span> (!res) {</div>
<div class="line">        dev_err(&amp;pdev-&gt;dev, <span class="stringliteral">&quot;No memory resource\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -ENODEV;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Request memory region</span></div>
<div class="line">    dev-&gt;mem_res = devm_request_mem_region(&amp;pdev-&gt;dev,</div>
<div class="line">                                          res-&gt;start,</div>
<div class="line">                                          resource_size(res),</div>
<div class="line">                                          pdev-&gt;name);</div>
<div class="line">    <span class="keywordflow">if</span> (!dev-&gt;mem_res) {</div>
<div class="line">        dev_err(&amp;pdev-&gt;dev, <span class="stringliteral">&quot;Memory region busy\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -EBUSY;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Map memory</span></div>
<div class="line">    dev-&gt;base = devm_ioremap(&amp;pdev-&gt;dev, res-&gt;start, resource_size(res));</div>
<div class="line">    <span class="keywordflow">if</span> (!dev-&gt;base) {</div>
<div class="line">        dev_err(&amp;pdev-&gt;dev, <span class="stringliteral">&quot;Failed to map memory\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Initialize device</span></div>
<div class="line">    ret = mmio_device_init(dev);</div>
<div class="line">    <span class="keywordflow">if</span> (ret) {</div>
<div class="line">        dev_err(&amp;pdev-&gt;dev, <span class="stringliteral">&quot;Device initialization failed\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> ret;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    platform_set_drvdata(pdev, dev);</div>
<div class="line">    </div>
<div class="line">    dev_info(&amp;pdev-&gt;dev, <span class="stringliteral">&quot;Device initialized at 0x%lx\n&quot;</span>,</div>
<div class="line">            (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)res-&gt;start);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> mmio_remove(<span class="keyword">struct</span> platform_device *pdev)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>mmio_device *dev = platform_get_drvdata(pdev);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Disable device</span></div>
<div class="line">    mmio_write_reg(dev, REG_CONTROL, 0);</div>
<div class="line">    </div>
<div class="line">    dev_info(&amp;pdev-&gt;dev, <span class="stringliteral">&quot;Device removed\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>platform_driver mmio_driver = {</div>
<div class="line">    .probe = mmio_probe,</div>
<div class="line">    .remove = mmio_remove,</div>
<div class="line">    .driver = {</div>
<div class="line">        .name = DEVICE_NAME,</div>
<div class="line">    },</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">module_platform_driver(mmio_driver);</div>
<div class="line"> </div>
<div class="line">MODULE_LICENSE(<span class="stringliteral">&quot;GPL&quot;</span>);</div>
<div class="line">MODULE_AUTHOR(<span class="stringliteral">&quot;Your Name&quot;</span>);</div>
<div class="line">MODULE_DESCRIPTION(<span class="stringliteral">&quot;MMIO device driver example&quot;</span>);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md389"></a>
Checking I/O Resources</h1>
<div class="fragment"><div class="line"># View I/O port allocations</div>
<div class="line">cat /proc/ioports</div>
<div class="line"> </div>
<div class="line"># View memory allocations</div>
<div class="line">cat /proc/iomem</div>
<div class="line"> </div>
<div class="line"># Example output:</div>
<div class="line"># 0000-0cf7 : PCI Bus 0000:00</div>
<div class="line"># 0300-0307 : mydevice</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md390"></a>
Best Practices</h1>
<ol type="1">
<li><b>Always request resources</b> before accessing</li>
<li><b>Use ioremap</b> for memory-mapped I/O</li>
<li><b>Use ioread/iowrite</b> functions, not direct pointer access</li>
<li><b>Add memory barriers</b> when needed</li>
<li><b>Release resources</b> in reverse order</li>
<li><b>Use managed resources (devm_*)</b> when possible</li>
<li><b>Check resource availability</b> before use</li>
<li><b>Document register layout</b> clearly</li>
<li><b>Use macros</b> for register access</li>
<li><b>Test on target hardware</b></li>
</ol>
<h1><a class="anchor" id="autotoc_md391"></a>
Common Errors</h1>
<ul>
<li>Accessing I/O without requesting resources</li>
<li>Using wrong access size (8/16/32-bit)</li>
<li>Missing memory barriers</li>
<li>Not unmapping ioremap'd memory</li>
<li>Direct pointer dereference instead of ioread/iowrite</li>
<li>Incorrect register offsets</li>
</ul>
<h1><a class="anchor" id="autotoc_md392"></a>
Next Steps</h1>
<p>Proceed to <a class="el" href="md_12-linux-driver-model.html">Linux Driver Model</a> to learn about the kernel's device driver model. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri Feb 13 2026 16:02:32 for Linux Driver Development Manual by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
