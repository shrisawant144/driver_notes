<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Linux Driver Development Manual: Platform Device Drivers</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Linux Driver Development Manual
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">Comprehensive guide to Linux kernel and device driver development</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Platform Device Drivers </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md237"></a>
Overview</h1>
<p>Platform devices are pseudo-devices used to represent devices that are not discoverable by hardware (unlike PCI or USB). They are commonly used for SoC (System-on-Chip) integrated peripherals and devices described in device tree.</p>
<h1><a class="anchor" id="autotoc_md238"></a>
Platform Device Model</h1>
<h2><a class="anchor" id="autotoc_md239"></a>
Architecture</h2>
<div class="fragment"><div class="line">Platform Bus</div>
<div class="line">    ├── Platform Device (Hardware description)</div>
<div class="line">    └── Platform Driver (Software driver)</div>
</div><!-- fragment --><p>When a platform device and driver match, the driver's probe function is called.</p>
<h1><a class="anchor" id="autotoc_md240"></a>
Platform Device</h1>
<h2><a class="anchor" id="autotoc_md241"></a>
Structure</h2>
<div class="fragment"><div class="line"><span class="keyword">struct </span>platform_device {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *name;</div>
<div class="line">    <span class="keywordtype">int</span> id;</div>
<div class="line">    <span class="keyword">struct </span>device dev;</div>
<div class="line">    u32 num_resources;</div>
<div class="line">    <span class="keyword">struct </span>resource *resource;</div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md242"></a>
Creating Platform Device</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/platform_device.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>resource my_resources[] = {</div>
<div class="line">    {</div>
<div class="line">        .start = 0x10000000,</div>
<div class="line">        .end   = 0x10000FFF,</div>
<div class="line">        .flags = IORESOURCE_MEM,</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">        .start = 42,</div>
<div class="line">        .end   = 42,</div>
<div class="line">        .flags = IORESOURCE_IRQ,</div>
<div class="line">    },</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>platform_device my_device = {</div>
<div class="line">    .name = <span class="stringliteral">&quot;my-platform-device&quot;</span>,</div>
<div class="line">    .id = -1,</div>
<div class="line">    .num_resources = ARRAY_SIZE(my_resources),</div>
<div class="line">    .resource = my_resources,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> __init device_init(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> platform_device_register(&amp;my_device);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> __exit device_exit(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    platform_device_unregister(&amp;my_device);</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md243"></a>
Platform Driver</h1>
<h2><a class="anchor" id="autotoc_md244"></a>
Structure</h2>
<div class="fragment"><div class="line"><span class="keyword">struct </span>platform_driver {</div>
<div class="line">    int (*probe)(<span class="keyword">struct </span>platform_device *);</div>
<div class="line">    int (*remove)(<span class="keyword">struct </span>platform_device *);</div>
<div class="line">    void (*shutdown)(<span class="keyword">struct </span>platform_device *);</div>
<div class="line">    int (*suspend)(<span class="keyword">struct </span>platform_device *, pm_message_t state);</div>
<div class="line">    int (*resume)(<span class="keyword">struct </span>platform_device *);</div>
<div class="line">    <span class="keyword">struct </span>device_driver driver;</div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md245"></a>
Implementing Platform Driver</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/module.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/platform_device.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/mod_devicetable.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> my_probe(<span class="keyword">struct</span> platform_device *pdev)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>resource *res;</div>
<div class="line">    <span class="keywordtype">void</span> __iomem *base;</div>
<div class="line">    <span class="keywordtype">int</span> irq;</div>
<div class="line">    </div>
<div class="line">    printk(KERN_INFO <span class="stringliteral">&quot;Device probed: %s\n&quot;</span>, pdev-&gt;name);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Get memory resource</span></div>
<div class="line">    res = platform_get_resource(pdev, IORESOURCE_MEM, 0);</div>
<div class="line">    <span class="keywordflow">if</span> (!res) {</div>
<div class="line">        dev_err(&amp;pdev-&gt;dev, <span class="stringliteral">&quot;No memory resource\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -ENODEV;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Request memory region</span></div>
<div class="line">    <span class="keywordflow">if</span> (!request_mem_region(res-&gt;start, resource_size(res), pdev-&gt;name)) {</div>
<div class="line">        dev_err(&amp;pdev-&gt;dev, <span class="stringliteral">&quot;Memory region busy\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -EBUSY;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Map memory</span></div>
<div class="line">    base = ioremap(res-&gt;start, resource_size(res));</div>
<div class="line">    <span class="keywordflow">if</span> (!base) {</div>
<div class="line">        release_mem_region(res-&gt;start, resource_size(res));</div>
<div class="line">        <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Get IRQ</span></div>
<div class="line">    irq = platform_get_irq(pdev, 0);</div>
<div class="line">    <span class="keywordflow">if</span> (irq &lt; 0) {</div>
<div class="line">        dev_err(&amp;pdev-&gt;dev, <span class="stringliteral">&quot;No IRQ resource\n&quot;</span>);</div>
<div class="line">        iounmap(base);</div>
<div class="line">        release_mem_region(res-&gt;start, resource_size(res));</div>
<div class="line">        <span class="keywordflow">return</span> irq;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Store in device data</span></div>
<div class="line">    platform_set_drvdata(pdev, base);</div>
<div class="line">    </div>
<div class="line">    dev_info(&amp;pdev-&gt;dev, <span class="stringliteral">&quot;Initialized at 0x%lx, IRQ %d\n&quot;</span>,</div>
<div class="line">             (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)res-&gt;start, irq);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> my_remove(<span class="keyword">struct</span> platform_device *pdev)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">void</span> __iomem *base = platform_get_drvdata(pdev);</div>
<div class="line">    <span class="keyword">struct </span>resource *res;</div>
<div class="line">    </div>
<div class="line">    printk(KERN_INFO <span class="stringliteral">&quot;Device removed: %s\n&quot;</span>, pdev-&gt;name);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Unmap memory</span></div>
<div class="line">    <span class="keywordflow">if</span> (base)</div>
<div class="line">        iounmap(base);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Release memory region</span></div>
<div class="line">    res = platform_get_resource(pdev, IORESOURCE_MEM, 0);</div>
<div class="line">    <span class="keywordflow">if</span> (res)</div>
<div class="line">        release_mem_region(res-&gt;start, resource_size(res));</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>platform_driver my_driver = {</div>
<div class="line">    .probe = my_probe,</div>
<div class="line">    .remove = my_remove,</div>
<div class="line">    .driver = {</div>
<div class="line">        .name = <span class="stringliteral">&quot;my-platform-device&quot;</span>,</div>
<div class="line">        .owner = THIS_MODULE,</div>
<div class="line">    },</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">module_platform_driver(my_driver);</div>
<div class="line"> </div>
<div class="line">MODULE_LICENSE(<span class="stringliteral">&quot;GPL&quot;</span>);</div>
<div class="line">MODULE_AUTHOR(<span class="stringliteral">&quot;Your Name&quot;</span>);</div>
<div class="line">MODULE_DESCRIPTION(<span class="stringliteral">&quot;Platform device driver example&quot;</span>);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md246"></a>
Device Tree Integration</h1>
<h2><a class="anchor" id="autotoc_md247"></a>
Device Tree Node</h2>
<div class="fragment"><div class="line">my_device: mydevice@10000000 {</div>
<div class="line">    compatible = &quot;vendor,my-device&quot;;</div>
<div class="line">    reg = &lt;0x10000000 0x1000&gt;;</div>
<div class="line">    interrupts = &lt;0 42 4&gt;;</div>
<div class="line">    clock-frequency = &lt;100000000&gt;;</div>
<div class="line">    status = &quot;okay&quot;;</div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md248"></a>
Driver with Device Tree</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/of.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/of_device.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span>of_device_id my_of_match[] = {</div>
<div class="line">    { .compatible = <span class="stringliteral">&quot;vendor,my-device&quot;</span>, },</div>
<div class="line">    { }</div>
<div class="line">};</div>
<div class="line">MODULE_DEVICE_TABLE(of, my_of_match);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> my_probe(<span class="keyword">struct</span> platform_device *pdev)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>device_node *np = pdev-&gt;dev.of_node;</div>
<div class="line">    u32 clock_freq;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Read device tree properties</span></div>
<div class="line">    <span class="keywordflow">if</span> (of_property_read_u32(np, <span class="stringliteral">&quot;clock-frequency&quot;</span>, &amp;clock_freq)) {</div>
<div class="line">        dev_err(&amp;pdev-&gt;dev, <span class="stringliteral">&quot;Missing clock-frequency property\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    dev_info(&amp;pdev-&gt;dev, <span class="stringliteral">&quot;Clock frequency: %u Hz\n&quot;</span>, clock_freq);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// ... rest of probe</span></div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>platform_driver my_driver = {</div>
<div class="line">    .probe = my_probe,</div>
<div class="line">    .remove = my_remove,</div>
<div class="line">    .driver = {</div>
<div class="line">        .name = <span class="stringliteral">&quot;my-platform-device&quot;</span>,</div>
<div class="line">        .owner = THIS_MODULE,</div>
<div class="line">        .of_match_table = my_of_match,</div>
<div class="line">    },</div>
<div class="line">};</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md249"></a>
Resource Management</h1>
<h2><a class="anchor" id="autotoc_md250"></a>
Resource Types</h2>
<div class="fragment"><div class="line">IORESOURCE_MEM    <span class="comment">// Memory region</span></div>
<div class="line">IORESOURCE_IO     <span class="comment">// I/O port</span></div>
<div class="line">IORESOURCE_IRQ    <span class="comment">// Interrupt</span></div>
<div class="line">IORESOURCE_DMA    <span class="comment">// DMA channel</span></div>
<div class="line">IORESOURCE_BUS    <span class="comment">// Bus</span></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md251"></a>
Getting Resources</h2>
<div class="fragment"><div class="line"><span class="comment">// Get resource by index</span></div>
<div class="line"><span class="keyword">struct </span>resource *res = platform_get_resource(pdev, IORESOURCE_MEM, 0);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Get IRQ</span></div>
<div class="line"><span class="keywordtype">int</span> irq = platform_get_irq(pdev, 0);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Get resource by name</span></div>
<div class="line">res = platform_get_resource_byname(pdev, IORESOURCE_MEM, <span class="stringliteral">&quot;control&quot;</span>);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md252"></a>
Managed Resources (devm_*)</h2>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> my_probe(<span class="keyword">struct</span> platform_device *pdev)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>resource *res;</div>
<div class="line">    <span class="keywordtype">void</span> __iomem *base;</div>
<div class="line">    </div>
<div class="line">    res = platform_get_resource(pdev, IORESOURCE_MEM, 0);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Managed ioremap - automatically freed on driver detach</span></div>
<div class="line">    base = devm_ioremap_resource(&amp;pdev-&gt;dev, res);</div>
<div class="line">    <span class="keywordflow">if</span> (IS_ERR(base))</div>
<div class="line">        <span class="keywordflow">return</span> PTR_ERR(base);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Managed memory allocation</span></div>
<div class="line">    <span class="keyword">struct </span>my_data *data = devm_kzalloc(&amp;pdev-&gt;dev, <span class="keyword">sizeof</span>(*data), GFP_KERNEL);</div>
<div class="line">    <span class="keywordflow">if</span> (!data)</div>
<div class="line">        <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// No need to free in remove function</span></div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md253"></a>
Complete Platform Driver Example</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/module.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/platform_device.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/of.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/io.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/interrupt.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/fs.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/cdev.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define DEVICE_NAME &quot;myplatdev&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>myplat_device {</div>
<div class="line">    <span class="keywordtype">void</span> __iomem *base;</div>
<div class="line">    <span class="keywordtype">int</span> irq;</div>
<div class="line">    <span class="keyword">struct </span>cdev cdev;</div>
<div class="line">    dev_t devt;</div>
<div class="line">    <span class="keyword">struct </span>class *<span class="keyword">class</span>;</div>
<div class="line">    <span class="keyword">struct </span>device *device;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> irqreturn_t myplat_irq_handler(<span class="keywordtype">int</span> irq, <span class="keywordtype">void</span> *dev_id)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>myplat_device *mydev = dev_id;</div>
<div class="line">    </div>
<div class="line">    printk(KERN_INFO <span class="stringliteral">&quot;Interrupt received\n&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Handle interrupt</span></div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> IRQ_HANDLED;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> myplat_open(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>myplat_device *mydev;</div>
<div class="line">    mydev = container_of(inode-&gt;i_cdev, <span class="keyword">struct</span> myplat_device, cdev);</div>
<div class="line">    filp-&gt;private_data = mydev;</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> myplat_release(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> ssize_t myplat_read(<span class="keyword">struct</span> file *filp, <span class="keywordtype">char</span> __user *buf,</div>
<div class="line">                          <span class="keywordtype">size_t</span> count, loff_t *f_pos)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>myplat_device *mydev = filp-&gt;private_data;</div>
<div class="line">    u32 value;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Read from hardware register</span></div>
<div class="line">    value = ioread32(mydev-&gt;base);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (copy_to_user(buf, &amp;value, <span class="keyword">sizeof</span>(value)))</div>
<div class="line">        <span class="keywordflow">return</span> -EFAULT;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">sizeof</span>(value);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> ssize_t myplat_write(<span class="keyword">struct</span> file *filp, <span class="keyword">const</span> <span class="keywordtype">char</span> __user *buf,</div>
<div class="line">                           <span class="keywordtype">size_t</span> count, loff_t *f_pos)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>myplat_device *mydev = filp-&gt;private_data;</div>
<div class="line">    u32 value;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (count &lt; <span class="keyword">sizeof</span>(value))</div>
<div class="line">        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (copy_from_user(&amp;value, buf, <span class="keyword">sizeof</span>(value)))</div>
<div class="line">        <span class="keywordflow">return</span> -EFAULT;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Write to hardware register</span></div>
<div class="line">    iowrite32(value, mydev-&gt;base);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">sizeof</span>(value);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>file_operations myplat_fops = {</div>
<div class="line">    .owner = THIS_MODULE,</div>
<div class="line">    .open = myplat_open,</div>
<div class="line">    .release = myplat_release,</div>
<div class="line">    .read = myplat_read,</div>
<div class="line">    .write = myplat_write,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> myplat_probe(<span class="keyword">struct</span> platform_device *pdev)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>myplat_device *mydev;</div>
<div class="line">    <span class="keyword">struct </span>resource *res;</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line">    </div>
<div class="line">    dev_info(&amp;pdev-&gt;dev, <span class="stringliteral">&quot;Probing device\n&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Allocate device structure</span></div>
<div class="line">    mydev = devm_kzalloc(&amp;pdev-&gt;dev, <span class="keyword">sizeof</span>(*mydev), GFP_KERNEL);</div>
<div class="line">    <span class="keywordflow">if</span> (!mydev)</div>
<div class="line">        <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Get and map memory resource</span></div>
<div class="line">    res = platform_get_resource(pdev, IORESOURCE_MEM, 0);</div>
<div class="line">    mydev-&gt;base = devm_ioremap_resource(&amp;pdev-&gt;dev, res);</div>
<div class="line">    <span class="keywordflow">if</span> (IS_ERR(mydev-&gt;base))</div>
<div class="line">        <span class="keywordflow">return</span> PTR_ERR(mydev-&gt;base);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Get IRQ</span></div>
<div class="line">    mydev-&gt;irq = platform_get_irq(pdev, 0);</div>
<div class="line">    <span class="keywordflow">if</span> (mydev-&gt;irq &gt;= 0) {</div>
<div class="line">        ret = devm_request_irq(&amp;pdev-&gt;dev, mydev-&gt;irq, myplat_irq_handler,</div>
<div class="line">                              0, dev_name(&amp;pdev-&gt;dev), mydev);</div>
<div class="line">        <span class="keywordflow">if</span> (ret) {</div>
<div class="line">            dev_err(&amp;pdev-&gt;dev, <span class="stringliteral">&quot;Failed to request IRQ\n&quot;</span>);</div>
<div class="line">            <span class="keywordflow">return</span> ret;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Allocate character device number</span></div>
<div class="line">    ret = alloc_chrdev_region(&amp;mydev-&gt;devt, 0, 1, DEVICE_NAME);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line">        dev_err(&amp;pdev-&gt;dev, <span class="stringliteral">&quot;Failed to allocate device number\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> ret;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Initialize and add cdev</span></div>
<div class="line">    cdev_init(&amp;mydev-&gt;cdev, &amp;myplat_fops);</div>
<div class="line">    mydev-&gt;cdev.owner = THIS_MODULE;</div>
<div class="line">    </div>
<div class="line">    ret = cdev_add(&amp;mydev-&gt;cdev, mydev-&gt;devt, 1);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line">        unregister_chrdev_region(mydev-&gt;devt, 1);</div>
<div class="line">        <span class="keywordflow">return</span> ret;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Create device class</span></div>
<div class="line">    mydev-&gt;class = class_create(THIS_MODULE, DEVICE_NAME);</div>
<div class="line">    <span class="keywordflow">if</span> (IS_ERR(mydev-&gt;class)) {</div>
<div class="line">        cdev_del(&amp;mydev-&gt;cdev);</div>
<div class="line">        unregister_chrdev_region(mydev-&gt;devt, 1);</div>
<div class="line">        <span class="keywordflow">return</span> PTR_ERR(mydev-&gt;class);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Create device</span></div>
<div class="line">    mydev-&gt;device = device_create(mydev-&gt;class, &amp;pdev-&gt;dev, mydev-&gt;devt,</div>
<div class="line">                                  NULL, DEVICE_NAME);</div>
<div class="line">    <span class="keywordflow">if</span> (IS_ERR(mydev-&gt;device)) {</div>
<div class="line">        class_destroy(mydev-&gt;class);</div>
<div class="line">        cdev_del(&amp;mydev-&gt;cdev);</div>
<div class="line">        unregister_chrdev_region(mydev-&gt;devt, 1);</div>
<div class="line">        <span class="keywordflow">return</span> PTR_ERR(mydev-&gt;device);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    platform_set_drvdata(pdev, mydev);</div>
<div class="line">    </div>
<div class="line">    dev_info(&amp;pdev-&gt;dev, <span class="stringliteral">&quot;Device initialized successfully\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> myplat_remove(<span class="keyword">struct</span> platform_device *pdev)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>myplat_device *mydev = platform_get_drvdata(pdev);</div>
<div class="line">    </div>
<div class="line">    device_destroy(mydev-&gt;class, mydev-&gt;devt);</div>
<div class="line">    class_destroy(mydev-&gt;class);</div>
<div class="line">    cdev_del(&amp;mydev-&gt;cdev);</div>
<div class="line">    unregister_chrdev_region(mydev-&gt;devt, 1);</div>
<div class="line">    </div>
<div class="line">    dev_info(&amp;pdev-&gt;dev, <span class="stringliteral">&quot;Device removed\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span>of_device_id myplat_of_match[] = {</div>
<div class="line">    { .compatible = <span class="stringliteral">&quot;vendor,myplatdev&quot;</span>, },</div>
<div class="line">    { }</div>
<div class="line">};</div>
<div class="line">MODULE_DEVICE_TABLE(of, myplat_of_match);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>platform_driver myplat_driver = {</div>
<div class="line">    .probe = myplat_probe,</div>
<div class="line">    .remove = myplat_remove,</div>
<div class="line">    .driver = {</div>
<div class="line">        .name = DEVICE_NAME,</div>
<div class="line">        .owner = THIS_MODULE,</div>
<div class="line">        .of_match_table = myplat_of_match,</div>
<div class="line">    },</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">module_platform_driver(myplat_driver);</div>
<div class="line"> </div>
<div class="line">MODULE_LICENSE(<span class="stringliteral">&quot;GPL&quot;</span>);</div>
<div class="line">MODULE_AUTHOR(<span class="stringliteral">&quot;Your Name&quot;</span>);</div>
<div class="line">MODULE_DESCRIPTION(<span class="stringliteral">&quot;Complete platform device driver&quot;</span>);</div>
<div class="line">MODULE_VERSION(<span class="stringliteral">&quot;1.0&quot;</span>);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md254"></a>
Power Management</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#ifdef CONFIG_PM</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> myplat_suspend(<span class="keyword">struct</span> device *dev)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>myplat_device *mydev = dev_get_drvdata(dev);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Save device state</span></div>
<div class="line">    <span class="comment">// Disable clocks, power down</span></div>
<div class="line">    </div>
<div class="line">    dev_info(dev, <span class="stringliteral">&quot;Device suspended\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> myplat_resume(<span class="keyword">struct</span> device *dev)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>myplat_device *mydev = dev_get_drvdata(dev);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Restore device state</span></div>
<div class="line">    <span class="comment">// Enable clocks, power up</span></div>
<div class="line">    </div>
<div class="line">    dev_info(dev, <span class="stringliteral">&quot;Device resumed\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span>dev_pm_ops myplat_pm_ops = {</div>
<div class="line">    .suspend = myplat_suspend,</div>
<div class="line">    .resume = myplat_resume,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define MYPLAT_PM_OPS (&amp;myplat_pm_ops)</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor">#define MYPLAT_PM_OPS NULL</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>platform_driver myplat_driver = {</div>
<div class="line">    .probe = myplat_probe,</div>
<div class="line">    .remove = myplat_remove,</div>
<div class="line">    .driver = {</div>
<div class="line">        .name = DEVICE_NAME,</div>
<div class="line">        .owner = THIS_MODULE,</div>
<div class="line">        .of_match_table = myplat_of_match,</div>
<div class="line">        .pm = MYPLAT_PM_OPS,</div>
<div class="line">    },</div>
<div class="line">};</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md255"></a>
Platform Data</h1>
<h2><a class="anchor" id="autotoc_md256"></a>
Passing Platform Data</h2>
<div class="fragment"><div class="line"><span class="keyword">struct </span>myplat_platform_data {</div>
<div class="line">    <span class="keywordtype">int</span> gpio_pin;</div>
<div class="line">    <span class="keywordtype">int</span> clock_rate;</div>
<div class="line">    <span class="keywordtype">bool</span> enable_feature;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>myplat_platform_data my_pdata = {</div>
<div class="line">    .gpio_pin = 42,</div>
<div class="line">    .clock_rate = 100000000,</div>
<div class="line">    .enable_feature = <span class="keyword">true</span>,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>platform_device my_device = {</div>
<div class="line">    .name = <span class="stringliteral">&quot;myplatdev&quot;</span>,</div>
<div class="line">    .id = -1,</div>
<div class="line">    .dev = {</div>
<div class="line">        .platform_data = &amp;my_pdata,</div>
<div class="line">    },</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// In driver probe</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> myplat_probe(<span class="keyword">struct</span> platform_device *pdev)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>myplat_platform_data *pdata = dev_get_platdata(&amp;pdev-&gt;dev);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (pdata) {</div>
<div class="line">        printk(KERN_INFO <span class="stringliteral">&quot;GPIO pin: %d\n&quot;</span>, pdata-&gt;gpio_pin);</div>
<div class="line">        printk(KERN_INFO <span class="stringliteral">&quot;Clock rate: %d\n&quot;</span>, pdata-&gt;clock_rate);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md257"></a>
Best Practices</h1>
<ol type="1">
<li><b>Use managed resources (devm_*)</b> for automatic cleanup</li>
<li><b>Implement proper error handling</b> in probe</li>
<li><b>Support device tree</b> for modern systems</li>
<li><b>Add power management</b> support</li>
<li><b>Use platform_set_drvdata</b> to store device context</li>
<li><b>Check resource availability</b> before use</li>
<li><b>Provide module device table</b> for auto-loading</li>
</ol>
<h1><a class="anchor" id="autotoc_md258"></a>
Next Steps</h1>
<p>Proceed to <a class="el" href="md_07-kernel-data-structures.html">Kernel Data Structures</a> to learn about kernel-provided data structures. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri Feb 13 2026 16:02:32 for Linux Driver Development Manual by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
