<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Linux Driver Development Manual: Kernel Memory Management</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Linux Driver Development Manual
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">Comprehensive guide to Linux kernel and device driver development</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Kernel Memory Management </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md335"></a>
Overview</h1>
<p>Kernel memory management differs significantly from user space. This chapter covers memory allocation, DMA, and memory mapping in kernel drivers.</p>
<h1><a class="anchor" id="autotoc_md336"></a>
Memory Zones</h1>
<p>Linux divides physical memory into zones:</p>
<ul>
<li><b>ZONE_DMA</b>: Memory for DMA (&lt; 16MB on x86)</li>
<li><b>ZONE_DMA32</b>: DMA memory &lt; 4GB (x86_64)</li>
<li><b>ZONE_NORMAL</b>: Normal memory</li>
<li><b>ZONE_HIGHMEM</b>: High memory (&gt; 896MB on 32-bit)</li>
</ul>
<h1><a class="anchor" id="autotoc_md337"></a>
kmalloc</h1>
<p>Allocates physically contiguous memory.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/slab.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> *kmalloc(<span class="keywordtype">size_t</span> size, gfp_t flags);</div>
<div class="line"><span class="keywordtype">void</span> kfree(<span class="keyword">const</span> <span class="keywordtype">void</span> *ptr);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md338"></a>
GFP Flags</h2>
<div class="fragment"><div class="line">GFP_KERNEL      <span class="comment">// Normal allocation, can sleep</span></div>
<div class="line">GFP_ATOMIC      <span class="comment">// Cannot sleep, for interrupt context</span></div>
<div class="line">GFP_USER        <span class="comment">// User space allocation</span></div>
<div class="line">GFP_HIGHUSER    <span class="comment">// High memory for user space</span></div>
<div class="line">GFP_DMA         <span class="comment">// DMA-capable memory</span></div>
<div class="line">GFP_DMA32       <span class="comment">// DMA memory &lt; 4GB</span></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md339"></a>
Common Combinations</h2>
<div class="fragment"><div class="line">GFP_KERNEL      <span class="comment">// Process context, can sleep</span></div>
<div class="line">GFP_ATOMIC      <span class="comment">// Interrupt context, cannot sleep</span></div>
<div class="line">GFP_KERNEL | __GFP_ZERO  <span class="comment">// Zero-initialized memory</span></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md340"></a>
Example</h2>
<div class="fragment"><div class="line"><span class="comment">// Allocate memory</span></div>
<div class="line"><span class="keywordtype">char</span> *buffer = kmalloc(1024, GFP_KERNEL);</div>
<div class="line"><span class="keywordflow">if</span> (!buffer) {</div>
<div class="line">    printk(KERN_ERR <span class="stringliteral">&quot;Failed to allocate memory\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Use buffer</span></div>
<div class="line">strcpy(buffer, <span class="stringliteral">&quot;Hello&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Free memory</span></div>
<div class="line">kfree(buffer);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md341"></a>
kzalloc</h1>
<p>Allocates zero-initialized memory.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> *kzalloc(<span class="keywordtype">size_t</span> size, gfp_t flags);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Equivalent to:</span></div>
<div class="line"><span class="keywordtype">void</span> *ptr = kmalloc(size, flags);</div>
<div class="line"><span class="keywordflow">if</span> (ptr)</div>
<div class="line">    memset(ptr, 0, size);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md342"></a>
vmalloc</h1>
<p>Allocates virtually contiguous memory (may be physically fragmented).</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/vmalloc.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> *vmalloc(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> size);</div>
<div class="line"><span class="keywordtype">void</span> vfree(<span class="keyword">const</span> <span class="keywordtype">void</span> *addr);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Example</span></div>
<div class="line"><span class="keywordtype">char</span> *buffer = vmalloc(1024 * 1024);  <span class="comment">// 1MB</span></div>
<div class="line"><span class="keywordflow">if</span> (!buffer)</div>
<div class="line">    <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Use buffer</span></div>
<div class="line">memset(buffer, 0, 1024 * 1024);</div>
<div class="line"> </div>
<div class="line">vfree(buffer);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md343"></a>
kmalloc vs vmalloc</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Feature </th><th class="markdownTableHeadNone">kmalloc </th><th class="markdownTableHeadNone">vmalloc  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Physical </td><td class="markdownTableBodyNone">Contiguous </td><td class="markdownTableBodyNone">Fragmented  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Size </td><td class="markdownTableBodyNone">Limited </td><td class="markdownTableBodyNone">Large  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Speed </td><td class="markdownTableBodyNone">Fast </td><td class="markdownTableBodyNone">Slower  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Use case </td><td class="markdownTableBodyNone">Small allocations </td><td class="markdownTableBodyNone">Large buffers  </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md344"></a>
Memory Pools</h1>
<p>Pre-allocated memory for critical allocations.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/mempool.h&gt;</span></div>
<div class="line"> </div>
<div class="line">mempool_t *mempool_create(<span class="keywordtype">int</span> min_nr, mempool_alloc_t *alloc_fn,</div>
<div class="line">                         mempool_free_t *free_fn, <span class="keywordtype">void</span> *pool_data);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Using kmalloc</span></div>
<div class="line">mempool_t *pool = mempool_create_kmalloc_pool(32, 1024);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Allocate from pool</span></div>
<div class="line"><span class="keywordtype">void</span> *ptr = mempool_alloc(pool, GFP_KERNEL);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Free to pool</span></div>
<div class="line">mempool_free(ptr, pool);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Destroy pool</span></div>
<div class="line">mempool_destroy(pool);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md345"></a>
Slab Allocator</h1>
<p>Efficient allocation for frequently used objects.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/slab.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>kmem_cache *cache;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create cache</span></div>
<div class="line">cache = kmem_cache_create(<span class="stringliteral">&quot;my_cache&quot;</span>,</div>
<div class="line">                         <span class="keyword">sizeof</span>(<span class="keyword">struct</span> my_object),</div>
<div class="line">                         0,</div>
<div class="line">                         SLAB_HWCACHE_ALIGN,</div>
<div class="line">                         NULL);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Allocate object</span></div>
<div class="line"><span class="keyword">struct </span>my_object *obj = kmem_cache_alloc(cache, GFP_KERNEL);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Free object</span></div>
<div class="line">kmem_cache_free(cache, obj);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Destroy cache</span></div>
<div class="line">kmem_cache_destroy(cache);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md346"></a>
Example</h2>
<div class="fragment"><div class="line"><span class="keyword">struct </span>my_data {</div>
<div class="line">    <span class="keywordtype">int</span> id;</div>
<div class="line">    <span class="keywordtype">char</span> name[32];</div>
<div class="line">    <span class="keywordtype">void</span> *ptr;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>kmem_cache *my_cache;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> __init cache_init(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    my_cache = kmem_cache_create(<span class="stringliteral">&quot;my_data_cache&quot;</span>,</div>
<div class="line">                                <span class="keyword">sizeof</span>(<span class="keyword">struct</span> my_data),</div>
<div class="line">                                0,</div>
<div class="line">                                SLAB_HWCACHE_ALIGN,</div>
<div class="line">                                NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (!my_cache)</div>
<div class="line">        <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Allocate objects</span></div>
<div class="line">    <span class="keyword">struct </span>my_data *obj1 = kmem_cache_alloc(my_cache, GFP_KERNEL);</div>
<div class="line">    <span class="keyword">struct </span>my_data *obj2 = kmem_cache_alloc(my_cache, GFP_KERNEL);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Use objects</span></div>
<div class="line">    obj1-&gt;id = 1;</div>
<div class="line">    strcpy(obj1-&gt;name, <span class="stringliteral">&quot;Object 1&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Free objects</span></div>
<div class="line">    kmem_cache_free(my_cache, obj1);</div>
<div class="line">    kmem_cache_free(my_cache, obj2);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> __exit cache_exit(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    kmem_cache_destroy(my_cache);</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md347"></a>
Per-CPU Variables</h1>
<p>Variables with separate instance per CPU.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/percpu.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Static per-CPU variable</span></div>
<div class="line">DEFINE_PER_CPU(<span class="keywordtype">int</span>, my_counter);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Access</span></div>
<div class="line"><span class="keywordtype">int</span> value = get_cpu_var(my_counter);</div>
<div class="line">value++;</div>
<div class="line">put_cpu_var(my_counter);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Or with preemption disabled</span></div>
<div class="line"><span class="keywordtype">int</span> *ptr = per_cpu_ptr(&amp;my_counter, cpu);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Dynamic allocation</span></div>
<div class="line"><span class="keywordtype">int</span> __percpu *counter = alloc_percpu(<span class="keywordtype">int</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Access</span></div>
<div class="line"><span class="keywordtype">int</span> *ptr = per_cpu_ptr(counter, smp_processor_id());</div>
<div class="line">*ptr = 42;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Free</span></div>
<div class="line">free_percpu(counter);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md348"></a>
Page Allocation</h1>
<p>Low-level page allocation.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/gfp.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Allocate pages</span></div>
<div class="line"><span class="keyword">struct </span>page *page = alloc_pages(GFP_KERNEL, order);  <span class="comment">// 2^order pages</span></div>
<div class="line"><span class="keywordtype">void</span> *addr = page_address(page);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Allocate single page</span></div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> addr = __get_free_page(GFP_KERNEL);</div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> addr = get_zeroed_page(GFP_KERNEL);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Free pages</span></div>
<div class="line">free_pages(addr, order);</div>
<div class="line">__free_page(page);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md349"></a>
DMA Memory</h1>
<h2><a class="anchor" id="autotoc_md350"></a>
Coherent DMA</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/dma-mapping.h&gt;</span></div>
<div class="line"> </div>
<div class="line">dma_addr_t dma_handle;</div>
<div class="line"><span class="keywordtype">void</span> *cpu_addr;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Allocate coherent DMA memory</span></div>
<div class="line">cpu_addr = dma_alloc_coherent(&amp;pdev-&gt;dev, size, &amp;dma_handle, GFP_KERNEL);</div>
<div class="line"><span class="keywordflow">if</span> (!cpu_addr)</div>
<div class="line">    <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Use memory</span></div>
<div class="line"><span class="comment">// cpu_addr: CPU address</span></div>
<div class="line"><span class="comment">// dma_handle: Device address</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Free memory</span></div>
<div class="line">dma_free_coherent(&amp;pdev-&gt;dev, size, cpu_addr, dma_handle);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md351"></a>
Streaming DMA</h2>
<div class="fragment"><div class="line"><span class="comment">// Map buffer for DMA</span></div>
<div class="line">dma_addr_t dma_addr = dma_map_single(&amp;pdev-&gt;dev, buffer, size, DMA_TO_DEVICE);</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">if</span> (dma_mapping_error(&amp;pdev-&gt;dev, dma_addr)) {</div>
<div class="line">    printk(KERN_ERR <span class="stringliteral">&quot;DMA mapping failed\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Perform DMA transfer</span></div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Unmap buffer</span></div>
<div class="line">dma_unmap_single(&amp;pdev-&gt;dev, dma_addr, size, DMA_TO_DEVICE);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md352"></a>
DMA Direction</h2>
<div class="fragment"><div class="line">DMA_TO_DEVICE       <span class="comment">// Data to device</span></div>
<div class="line">DMA_FROM_DEVICE     <span class="comment">// Data from device</span></div>
<div class="line">DMA_BIDIRECTIONAL   <span class="comment">// Both directions</span></div>
<div class="line">DMA_NONE            <span class="comment">// No data transfer</span></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md353"></a>
Example</h2>
<div class="fragment"><div class="line"><span class="keyword">struct </span>my_device {</div>
<div class="line">    <span class="keywordtype">void</span> *coherent_buf;</div>
<div class="line">    dma_addr_t dma_handle;</div>
<div class="line">    <span class="keywordtype">size_t</span> buf_size;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> setup_dma(<span class="keyword">struct</span> platform_device *pdev, <span class="keyword">struct</span> my_device *dev)</div>
<div class="line">{</div>
<div class="line">    dev-&gt;buf_size = 4096;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Set DMA mask</span></div>
<div class="line">    <span class="keywordflow">if</span> (dma_set_mask_and_coherent(&amp;pdev-&gt;dev, DMA_BIT_MASK(32))) {</div>
<div class="line">        dev_err(&amp;pdev-&gt;dev, <span class="stringliteral">&quot;Failed to set DMA mask\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Allocate DMA buffer</span></div>
<div class="line">    dev-&gt;coherent_buf = dma_alloc_coherent(&amp;pdev-&gt;dev,</div>
<div class="line">                                          dev-&gt;buf_size,</div>
<div class="line">                                          &amp;dev-&gt;dma_handle,</div>
<div class="line">                                          GFP_KERNEL);</div>
<div class="line">    <span class="keywordflow">if</span> (!dev-&gt;coherent_buf)</div>
<div class="line">        <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line">    </div>
<div class="line">    dev_info(&amp;pdev-&gt;dev, <span class="stringliteral">&quot;DMA buffer at 0x%llx\n&quot;</span>,</div>
<div class="line">            (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>)dev-&gt;dma_handle);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> cleanup_dma(<span class="keyword">struct</span> platform_device *pdev, <span class="keyword">struct</span> my_device *dev)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (dev-&gt;coherent_buf) {</div>
<div class="line">        dma_free_coherent(&amp;pdev-&gt;dev,</div>
<div class="line">                         dev-&gt;buf_size,</div>
<div class="line">                         dev-&gt;coherent_buf,</div>
<div class="line">                         dev-&gt;dma_handle);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md354"></a>
Memory Mapping (mmap)</h1>
<p>Map kernel memory to user space.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> device_mmap(<span class="keyword">struct</span> file *filp, <span class="keyword">struct</span> vm_area_struct *vma)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> size = vma-&gt;vm_end - vma-&gt;vm_start;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> pfn;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Check size</span></div>
<div class="line">    <span class="keywordflow">if</span> (size &gt; BUFFER_SIZE)</div>
<div class="line">        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Get page frame number</span></div>
<div class="line">    pfn = virt_to_phys(kernel_buffer) &gt;&gt; PAGE_SHIFT;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Map pages</span></div>
<div class="line">    <span class="keywordflow">if</span> (remap_pfn_range(vma,</div>
<div class="line">                       vma-&gt;vm_start,</div>
<div class="line">                       pfn,</div>
<div class="line">                       size,</div>
<div class="line">                       vma-&gt;vm_page_prot))</div>
<div class="line">        <span class="keywordflow">return</span> -EAGAIN;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// For DMA memory</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> device_mmap_dma(<span class="keyword">struct</span> file *filp, <span class="keyword">struct</span> vm_area_struct *vma)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>my_device *dev = filp-&gt;private_data;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> size = vma-&gt;vm_end - vma-&gt;vm_start;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> dma_mmap_coherent(&amp;dev-&gt;pdev-&gt;dev,</div>
<div class="line">                            vma,</div>
<div class="line">                            dev-&gt;coherent_buf,</div>
<div class="line">                            dev-&gt;dma_handle,</div>
<div class="line">                            size);</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md355"></a>
User Space Usage</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;sys/mman.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> fd = open(<span class="stringliteral">&quot;/dev/mydevice&quot;</span>, O_RDWR);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> *addr = mmap(NULL, 4096, PROT_READ | PROT_WRITE,</div>
<div class="line">                 MAP_SHARED, fd, 0);</div>
<div class="line"><span class="keywordflow">if</span> (addr == MAP_FAILED) {</div>
<div class="line">    perror(<span class="stringliteral">&quot;mmap&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Access mapped memory</span></div>
<div class="line"><span class="keywordtype">char</span> *buf = (<span class="keywordtype">char</span> *)addr;</div>
<div class="line">strcpy(buf, <span class="stringliteral">&quot;Hello from user space&quot;</span>);</div>
<div class="line"> </div>
<div class="line">munmap(addr, 4096);</div>
<div class="line">close(fd);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md356"></a>
Memory Barriers</h1>
<p>Ensure memory operation ordering.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/barrier.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Full memory barrier</span></div>
<div class="line">mb();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Read memory barrier</span></div>
<div class="line">rmb();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Write memory barrier</span></div>
<div class="line">wmb();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// SMP barriers</span></div>
<div class="line">smp_mb();</div>
<div class="line">smp_rmb();</div>
<div class="line">smp_wmb();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Example</span></div>
<div class="line">writel(value, reg);</div>
<div class="line">wmb();  <span class="comment">// Ensure write completes before next operation</span></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md357"></a>
Managed Resources (devm_*)</h1>
<p>Automatic cleanup on driver detach.</p>
<div class="fragment"><div class="line"><span class="comment">// Managed kmalloc</span></div>
<div class="line"><span class="keywordtype">void</span> *ptr = devm_kmalloc(&amp;pdev-&gt;dev, size, GFP_KERNEL);</div>
<div class="line"><span class="keywordtype">void</span> *ptr = devm_kzalloc(&amp;pdev-&gt;dev, size, GFP_KERNEL);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Managed DMA</span></div>
<div class="line"><span class="keywordtype">void</span> *cpu_addr = dmam_alloc_coherent(&amp;pdev-&gt;dev, size, &amp;dma_handle, GFP_KERNEL);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// No need to free - automatically freed on driver detach</span></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md358"></a>
Memory Debugging</h1>
<h2><a class="anchor" id="autotoc_md359"></a>
Kernel Configuration</h2>
<div class="fragment"><div class="line">CONFIG_DEBUG_SLAB          # Slab debugging</div>
<div class="line">CONFIG_DEBUG_PAGEALLOC     # Page allocation debugging</div>
<div class="line">CONFIG_KASAN               # Address sanitizer</div>
<div class="line">CONFIG_SLUB_DEBUG          # SLUB debugging</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md360"></a>
Detecting Leaks</h2>
<div class="fragment"><div class="line"># Check slab info</div>
<div class="line">cat /proc/slabinfo</div>
<div class="line"> </div>
<div class="line"># Memory info</div>
<div class="line">cat /proc/meminfo</div>
<div class="line"> </div>
<div class="line"># Check for leaks</div>
<div class="line">echo scan &gt; /sys/kernel/debug/kmemleak</div>
<div class="line">cat /sys/kernel/debug/kmemleak</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md361"></a>
Best Practices</h1>
<ol type="1">
<li><b>Always check allocation return value</b></li>
<li><b>Free memory in reverse order of allocation</b></li>
<li><b>Use appropriate allocation function</b> for context</li>
<li><b>Prefer managed resources (devm_*)</b> when possible</li>
<li><b>Use GFP_ATOMIC</b> in interrupt context</li>
<li><b>Avoid large kmalloc</b> allocations (use vmalloc)</li>
<li><b>Set DMA mask</b> before DMA operations</li>
<li><b>Use memory barriers</b> for hardware access</li>
<li><b>Test with memory debugging</b> enabled</li>
</ol>
<h1><a class="anchor" id="autotoc_md362"></a>
Common Errors</h1>
<ul>
<li>Memory leaks (not freeing allocated memory)</li>
<li>Use after free</li>
<li>Double free</li>
<li>Buffer overflow</li>
<li>Wrong GFP flags for context</li>
<li>Not checking allocation failure</li>
</ul>
<h1><a class="anchor" id="autotoc_md363"></a>
Complete Example</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;linux/module.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/slab.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/dma-mapping.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>my_device {</div>
<div class="line">    <span class="keywordtype">char</span> *kmalloc_buf;</div>
<div class="line">    <span class="keywordtype">char</span> *vmalloc_buf;</div>
<div class="line">    <span class="keywordtype">void</span> *dma_buf;</div>
<div class="line">    dma_addr_t dma_handle;</div>
<div class="line">    <span class="keyword">struct </span>kmem_cache *cache;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>my_device *dev;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> __init mem_init(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    dev = kzalloc(<span class="keyword">sizeof</span>(*dev), GFP_KERNEL);</div>
<div class="line">    <span class="keywordflow">if</span> (!dev)</div>
<div class="line">        <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// kmalloc</span></div>
<div class="line">    dev-&gt;kmalloc_buf = kmalloc(4096, GFP_KERNEL);</div>
<div class="line">    <span class="keywordflow">if</span> (!dev-&gt;kmalloc_buf)</div>
<div class="line">        <span class="keywordflow">goto</span> err_kmalloc;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// vmalloc</span></div>
<div class="line">    dev-&gt;vmalloc_buf = vmalloc(1024 * 1024);</div>
<div class="line">    <span class="keywordflow">if</span> (!dev-&gt;vmalloc_buf)</div>
<div class="line">        <span class="keywordflow">goto</span> err_vmalloc;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Slab cache</span></div>
<div class="line">    dev-&gt;cache = kmem_cache_create(<span class="stringliteral">&quot;my_cache&quot;</span>, 128, 0, 0, NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (!dev-&gt;cache)</div>
<div class="line">        <span class="keywordflow">goto</span> err_cache;</div>
<div class="line">    </div>
<div class="line">    printk(KERN_INFO <span class="stringliteral">&quot;Memory allocated successfully\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line"> </div>
<div class="line">err_cache:</div>
<div class="line">    vfree(dev-&gt;vmalloc_buf);</div>
<div class="line">err_vmalloc:</div>
<div class="line">    kfree(dev-&gt;kmalloc_buf);</div>
<div class="line">err_kmalloc:</div>
<div class="line">    kfree(dev);</div>
<div class="line">    <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> __exit mem_exit(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (dev) {</div>
<div class="line">        <span class="keywordflow">if</span> (dev-&gt;cache)</div>
<div class="line">            kmem_cache_destroy(dev-&gt;cache);</div>
<div class="line">        <span class="keywordflow">if</span> (dev-&gt;vmalloc_buf)</div>
<div class="line">            vfree(dev-&gt;vmalloc_buf);</div>
<div class="line">        <span class="keywordflow">if</span> (dev-&gt;kmalloc_buf)</div>
<div class="line">            kfree(dev-&gt;kmalloc_buf);</div>
<div class="line">        kfree(dev);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    printk(KERN_INFO <span class="stringliteral">&quot;Memory freed\n&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">module_init(mem_init);</div>
<div class="line">module_exit(mem_exit);</div>
<div class="line"> </div>
<div class="line">MODULE_LICENSE(<span class="stringliteral">&quot;GPL&quot;</span>);</div>
<div class="line">MODULE_DESCRIPTION(<span class="stringliteral">&quot;Memory management example&quot;</span>);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md364"></a>
Next Steps</h1>
<p>Proceed to <a class="el" href="md_11-io-port-access.html">IO Port Access</a> to learn about accessing hardware I/O ports and memory-mapped I/O. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri Feb 13 2026 16:02:32 for Linux Driver Development Manual by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
